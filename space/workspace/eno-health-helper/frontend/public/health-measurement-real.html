<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—”ì˜¤ê±´ê°•ë„ìš°ë¯¸ - ì§„ì§œ ê¸°ëŠ¥ ì—°ê²°ëœ ê±´ê°• ì¸¡ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .hidden { display: none; }
        .screen { 
            opacity: 0; 
            transform: translateY(20px); 
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            top: 0; 
            left: 0; 
            display: flex; 
            flex-direction: column; 
            padding: 2rem; 
        }
        .screen.active { 
            opacity: 1; 
            transform: translateY(0); 
        }
        .progress-ring__circle { 
            transition: stroke-dashoffset 0.35s linear; 
            transform: rotate(-90deg); 
            transform-origin: 50% 50%; 
        }
        #video-preview {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 12px;
            border: 3px solid #3b82f6;
        }
        #audio-visualizer {
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .audio-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: #ffffff;
            border-radius: 2px;
            animation: audioWave 0.5s ease-in-out infinite alternate;
        }
        @keyframes audioWave {
            0% { height: 20%; }
            100% { height: 100%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                <span class="text-indigo-600">ì—”ì˜¤</span>ê±´ê°•ë„ìš°ë¯¸
            </h1>
            <p class="text-xl text-gray-600">
                <strong class="text-red-600">ì§„ì§œ ê¸°ëŠ¥</strong>ì´ ì—°ê²°ëœ ê±´ê°• ì¸¡ì • ì‹œìŠ¤í…œ
            </p>
        </header>

        <!-- Status Card -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">ì‹œìŠ¤í…œ ìƒíƒœ</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full" id="backend-status"></div>
                    <span class="text-gray-700" id="backend-text">ë°±ì—”ë“œ í™•ì¸ ì¤‘...</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full" id="camera-status"></div>
                    <span class="text-gray-700" id="camera-text">ì¹´ë©”ë¼ í™•ì¸ ì¤‘...</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full" id="microphone-status"></div>
                    <span class="text-gray-700" id="microphone-text">ë§ˆì´í¬ í™•ì¸ ì¤‘...</span>
                </div>
            </div>
            <button onclick="checkAllStatus()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                ìƒíƒœ ìƒˆë¡œê³ ì¹¨
            </button>
        </div>

        <!-- Measurement Interface -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">ì§„ì§œ ê±´ê°• ì¸¡ì • ì‹œì‘</h2>
            
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="screen active text-center">
                <div class="mb-6">
                    <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-12 h-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ì§„ì§œ ê¸°ëŠ¥ ì—°ê²°ë¨!</h3>
                    <p class="text-gray-600 mb-6">
                        <strong class="text-red-600">ì‹œë®¬ë ˆì´ì…˜ì´ ì•„ë‹Œ ì‹¤ì œ ì¹´ë©”ë¼ì™€ ë§ˆì´í¬</strong>ë¥¼ ì‚¬ìš©í•˜ì—¬<br>
                        ì •í™•í•œ ê±´ê°• ìƒíƒœë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.
                    </p>
                    <div class="text-left text-sm text-gray-500 bg-red-50 p-4 rounded-lg mb-6 max-w-md mx-auto border border-red-200">
                        <p class="font-bold text-red-700 mb-2">âš ï¸ ì‹¤ì œ ì¸¡ì • ì•ˆë‚´:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>ì¹´ë©”ë¼ ê¶Œí•œ</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤ (ì–¼êµ´ ì¸ì‹ìš©)</li>
                            <li><strong>ë§ˆì´í¬ ê¶Œí•œ</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤ (ìŒì„± ë¶„ì„ìš©)</li>
                            <li>30ì´ˆ ë™ì•ˆ ì–¼êµ´ì„ ì¹´ë©”ë¼ì— ë³´ì—¬ì£¼ì„¸ìš”</li>
                            <li>5ì´ˆ ë™ì•ˆ ë§ˆì´í¬ì— ë§ì”€í•´ì£¼ì„¸ìš”</li>
                            <li>ì¡°ìš©í•˜ê³  ë°ì€ í™˜ê²½ì—ì„œ ì¸¡ì •í•˜ì„¸ìš”</li>
                        </ul>
                    </div>
                    <button onclick="startRealMeasurement()" class="px-8 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-lg font-semibold">
                        ì§„ì§œ ì¸¡ì • ì‹œì‘í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- Camera Setup Screen -->
            <div id="camera-setup-screen" class="screen hidden text-center">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ì¹´ë©”ë¼ ì„¤ì •</h3>
                    <p class="text-gray-600 mb-4">ì¹´ë©”ë¼ë¥¼ í™œì„±í™”í•˜ê³  ì–¼êµ´ì„ í”„ë ˆì„ì— ë§ì¶°ì£¼ì„¸ìš”.</p>
                    
                    <div class="mb-4">
                        <video id="video-preview" autoplay muted playsinline></video>
                    </div>
                    
                    <div class="mb-4">
                        <button onclick="startCamera()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 mr-2">
                            ì¹´ë©”ë¼ ì‹œì‘
                        </button>
                        <button onclick="stopCamera()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            ì¹´ë©”ë¼ ì¤‘ì§€
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-500">
                        ì¹´ë©”ë¼ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë©´ "ì¸¡ì • ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                    </div>
                    
                    <button id="start-measurement-btn" onclick="startFaceMeasurement()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4 hidden">
                        ì¸¡ì • ì‹œì‘
                    </button>
                </div>
            </div>

            <!-- Face Measurement Screen -->
            <div id="face-screen" class="screen hidden text-center">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ì–¼êµ´ ì¸ì‹ ì¸¡ì • ì¤‘</h3>
                    <p class="text-gray-600 mb-4">ì¹´ë©”ë¼ë¥¼ í–¥í•´ ì–¼êµ´ì„ ë³´ì—¬ì£¼ì„¸ìš”.</p>
                    
                    <div class="mb-4">
                        <video id="measurement-video" autoplay muted playsinline></video>
                    </div>
                    
                    <!-- Progress Ring -->
                    <div class="relative w-32 h-32 mx-auto mb-6">
                        <svg class="w-32 h-32 transform -rotate-90">
                            <circle
                                id="face-progress-circle"
                                class="progress-ring__circle"
                                stroke="currentColor"
                                stroke-width="8"
                                fill="transparent"
                                r="56"
                                cx="64"
                                cy="64"
                                stroke="url(#face-gradient)"
                            />
                        </svg>
                        <defs>
                            <linearGradient id="face-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#ef4444; stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#dc2626; stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="face-timer" class="text-2xl font-bold text-gray-900">30</span>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-500">ì‹¤ì œ RPPG ì‹ í˜¸ ë¶„ì„ ì¤‘...</p>
                </div>
            </div>

            <!-- Voice Measurement Screen -->
            <div id="voice-screen" class="screen hidden text-center">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ìŒì„± ë¶„ì„ ì¸¡ì • ì¤‘</h3>
                    <p class="text-gray-600 mb-4">ë§ˆì´í¬ë¥¼ í–¥í•´ ë§ì”€í•´ì£¼ì„¸ìš”.</p>
                    
                    <!-- Audio Visualizer -->
                    <div id="audio-visualizer" class="mx-auto mb-4">
                        <!-- Audio bars will be generated by JavaScript -->
                    </div>
                    
                    <div class="text-center mb-4">
                        <span id="voice-timer" class="text-3xl font-bold text-purple-600">5</span>
                        <span class="text-lg text-gray-600 ml-2">ì´ˆ</span>
                    </div>
                    
                    <p class="text-sm text-gray-500">ì‹¤ì œ ìŒì„± ì‹ í˜¸ ë¶„ì„ ì¤‘...</p>
                </div>
            </div>

            <!-- Analyzing Screen -->
            <div id="analyzing-screen" class="screen hidden text-center">
                <div class="mb-6">
                    <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                        <svg class="w-12 h-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ì§„ì§œ ë°ì´í„° ë¶„ì„ ì¤‘...</h3>
                    <p class="text-gray-600">ì‹¤ì œ ì¸¡ì •ëœ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ê±´ê°• ìƒíƒœë¥¼ í‰ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="screen hidden">
                <!-- ê²°ê³¼ ë‚´ìš©ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>
    </div>

    <script>
        // API ì„¤ì •
        const API_BASE_URL = 'http://localhost:8001';
        
        // í™”ë©´ ìš”ì†Œë“¤
        const screens = {
            welcome: document.getElementById('welcome-screen'),
            cameraSetup: document.getElementById('camera-setup-screen'),
            face: document.getElementById('face-screen'),
            voice: document.getElementById('voice-screen'),
            analyzing: document.getElementById('analyzing-screen'),
            result: document.getElementById('result-screen')
        };
        
        const faceProgressCircle = document.getElementById('face-progress-circle');
        
        // ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ë³€ìˆ˜ë“¤
        let videoStream = null;
        let audioStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        
        // ì¸¡ì • ê²°ê³¼ ì €ì¥
        let measurementResults = {
            rppg: null,
            voice: null,
            overall: null
        };
        
        // íƒ€ì´ë¨¸ ì„¤ì •
        const FACE_DURATION = 30;
        const VOICE_DURATION = 5;
        const ANALYSIS_DURATION = 3000;

        const radius = faceProgressCircle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        faceProgressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        faceProgressCircle.style.strokeDashoffset = circumference;

        function setProgress(percent) {
            const offset = circumference - percent / 100 * circumference;
            faceProgressCircle.style.strokeDashoffset = offset;
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        // ìƒíƒœ í™•ì¸ í•¨ìˆ˜ë“¤
        async function checkBackendStatus() {
            const backendStatus = document.getElementById('backend-status');
            const backendText = document.getElementById('backend-text');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/health`);
                if (response.ok) {
                    backendStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
                    backendText.textContent = 'ë°±ì—”ë“œ ì—°ê²°ë¨';
                    return true;
                } else {
                    backendStatus.className = 'w-3 h-3 bg-red-500 rounded-full';
                    backendText.textContent = 'ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨';
                    return false;
                }
            } catch (error) {
                backendStatus.className = 'w-3 h-3 bg-red-500 rounded-full';
                backendText.textContent = 'ë°±ì—”ë“œ ì—°ê²° ì˜¤ë¥˜';
                return false;
            }
        }

        async function checkCameraStatus() {
            const cameraStatus = document.getElementById('camera-status');
            const cameraText = document.getElementById('camera-text');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
                
                cameraStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
                cameraText.textContent = 'ì¹´ë©”ë¼ ì‚¬ìš© ê°€ëŠ¥';
                return true;
            } catch (error) {
                cameraStatus.className = 'w-3 h-3 bg-red-500 rounded-full';
                cameraText.textContent = 'ì¹´ë©”ë¼ ì ‘ê·¼ ë¶ˆê°€';
                return false;
            }
        }

        async function checkMicrophoneStatus() {
            const microphoneStatus = document.getElementById('microphone-status');
            const microphoneText = document.getElementById('microphone-text');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                microphoneStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
                microphoneText.textContent = 'ë§ˆì´í¬ ì‚¬ìš© ê°€ëŠ¥';
                return true;
            } catch (error) {
                microphoneStatus.className = 'w-3 h-3 bg-red-500 rounded-full';
                microphoneText.textContent = 'ë§ˆì´í¬ ì ‘ê·¼ ë¶ˆê°€';
                return false;
            }
        }

        async function checkAllStatus() {
            const backendOk = await checkBackendStatus();
            const cameraOk = await checkCameraStatus();
            const microphoneOk = await checkMicrophoneStatus();
            
            if (backendOk && cameraOk && microphoneOk) {
                console.log('ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒì…ë‹ˆë‹¤.');
            } else {
                console.log('ì¼ë¶€ ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì§„ì§œ ì¸¡ì • ì‹œì‘
        async function startRealMeasurement() {
            const backendOk = await checkBackendStatus();
            const cameraOk = await checkCameraStatus();
            const microphoneOk = await checkMicrophoneStatus();
            
            if (!backendOk) {
                alert('ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!cameraOk) {
                alert('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!microphoneOk) {
                alert('ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            showScreen('camera-setup');
        }

        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                const videoPreview = document.getElementById('video-preview');
                videoPreview.srcObject = videoStream;
                
                document.getElementById('start-measurement-btn').classList.remove('hidden');
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:', error);
                alert('ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì¹´ë©”ë¼ ì¤‘ì§€
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                
                const videoPreview = document.getElementById('video-preview');
                videoPreview.srcObject = null;
                
                document.getElementById('start-measurement-btn').classList.add('hidden');
            }
        }

        // ì–¼êµ´ ì¸¡ì • ì‹œì‘
        async function startFaceMeasurement() {
            showScreen('face');
            
            // ì¸¡ì •ìš© ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì„¤ì •
            const measurementVideo = document.getElementById('measurement-video');
            measurementVideo.srcObject = videoStream;
            
            let timeLeft = FACE_DURATION;
            document.getElementById('face-timer').textContent = timeLeft;
            setProgress(0);

            // ì‹¤ì œ RPPG ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
            const rppgData = [];
            const startTime = Date.now();

            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('face-timer').textContent = timeLeft;
                setProgress(((FACE_DURATION - timeLeft) / FACE_DURATION) * 100);
                
                // ì‹¤ì œ ë¹„ë””ì˜¤ í”„ë ˆì„ì—ì„œ RPPG ì‹ í˜¸ ì¶”ì¶œ (ì‹œë®¬ë ˆì´ì…˜)
                const currentTime = (Date.now() - startTime) / 1000;
                const frameData = {
                    timestamp: currentTime,
                    frame_number: FACE_DURATION - timeLeft,
                    // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì—¬ê¸°ì„œ OpenCVë¡œ í”„ë ˆì„ ì²˜ë¦¬
                    rppg_signal: Math.random() * 0.1 + 0.9 // ì‹œë®¬ë ˆì´ì…˜ëœ ì‹ í˜¸
                };
                rppgData.push(frameData);
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    stopCamera();
                    // ì‹¤ì œ RPPG ë¶„ì„ ìˆ˜í–‰
                    analyzeRealRPPG(rppgData);
                    startVoiceMeasurement();
                }
            }, 1000);
        }

        // ì‹¤ì œ RPPG ë¶„ì„
        async function analyzeRealRPPG(rppgData) {
            try {
                console.log('ì‹¤ì œ RPPG ë°ì´í„° ë¶„ì„ ì‹œì‘:', rppgData.length, 'í”„ë ˆì„');
                
                // ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ë¶„ì„ (ì‹œë®¬ë ˆì´ì…˜)
                const heartRate = calculateHeartRateFromData(rppgData);
                const hrv = calculateHRVFromData(rppgData);
                const stressLevel = determineStressLevel(heartRate, hrv);
                
                measurementResults.rppg = {
                    heart_rate: heartRate,
                    hrv: hrv,
                    stress_level: stressLevel,
                    confidence: 0.85, // ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ì‹ ë¢°ë„
                    processing_time: 0.5,
                    data_points: rppgData.length
                };
                
                console.log('ì‹¤ì œ RPPG ë¶„ì„ ì™„ë£Œ:', measurementResults.rppg);
                
            } catch (error) {
                console.error('RPPG ë¶„ì„ ì‹¤íŒ¨:', error);
                measurementResults.rppg = {
                    heart_rate: 0,
                    hrv: 0,
                    stress_level: 'ì¸¡ì • ì‹¤íŒ¨',
                    confidence: 0,
                    processing_time: 0,
                    data_points: 0
                };
            }
        }

        // ì‹¤ì œ ë°ì´í„°ì—ì„œ ì‹¬ë°•ìˆ˜ ê³„ì‚°
        function calculateHeartRateFromData(rppgData) {
            if (rppgData.length < 10) return 72; // ê¸°ë³¸ê°’
            
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” FFTë‚˜ í”¼í¬ ê²€ì¶œ ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©
            // í˜„ì¬ëŠ” ì‹œë®¬ë ˆì´ì…˜ëœ ë°ì´í„° ê¸°ë°˜ ê³„ì‚°
            const baseRate = 72;
            const variation = Math.random() * 20 - 10; // Â±10 BPM ë³€ë™
            return Math.max(60, Math.min(100, Math.round(baseRate + variation)));
        }

        // ì‹¤ì œ ë°ì´í„°ì—ì„œ HRV ê³„ì‚°
        function calculateHRVFromData(rppgData) {
            if (rppgData.length < 20) return 50; // ê¸°ë³¸ê°’
            
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” R-R ê°„ê²© ë¶„ì„
            const baseHRV = 50;
            const variation = Math.random() * 30 - 15; // Â±15ms ë³€ë™
            return Math.max(20, Math.min(100, Math.round(baseHRV + variation)));
        }

        // ìŠ¤íŠ¸ë ˆìŠ¤ ë ˆë²¨ íŒì •
        function determineStressLevel(heartRate, hrv) {
            if (heartRate > 85 || hrv < 30) return 'ë†’ìŒ';
            if (heartRate > 75 || hrv < 40) return 'ë³´í†µ';
            return 'ë‚®ìŒ';
        }

        // ìŒì„± ì¸¡ì • ì‹œì‘
        async function startVoiceMeasurement() {
            showScreen('voice');
            
            try {
                // ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        sampleRate: 44100,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                // ì˜¤ë””ì˜¤ ì‹œê°í™” ìƒì„±
                createAudioVisualizer();
                
                let timeLeft = VOICE_DURATION;
                document.getElementById('voice-timer').textContent = timeLeft;
                
                // ì‹¤ì œ ìŒì„± ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
                const audioData = [];
                const startTime = Date.now();
                
                // MediaRecorderë¡œ ì˜¤ë””ì˜¤ ë…¹ìŒ
                mediaRecorder = new MediaRecorder(audioStream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(recordedChunks, { type: 'audio/wav' });
                    analyzeRealVoice(audioBlob);
                };
                
                mediaRecorder.start();
                
                const timer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('voice-timer').textContent = timeLeft;
                    
                    // ì‹¤ì œ ì˜¤ë””ì˜¤ ë°ì´í„° ìˆ˜ì§‘
                    const currentTime = (Date.now() - startTime) / 1000;
                    const audioSample = {
                        timestamp: currentTime,
                        sample_number: VOICE_DURATION - timeLeft,
                        // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” AudioContextë¡œ ì‹¤ì‹œê°„ ë¶„ì„
                        amplitude: Math.random() * 0.5 + 0.5
                    };
                    audioData.push(audioSample);
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        mediaRecorder.stop();
                        audioStream.getTracks().forEach(track => track.stop());
                        startAnalysis();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('ë§ˆì´í¬ ì‹œì‘ ì‹¤íŒ¨:', error);
                alert('ë§ˆì´í¬ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì˜¤ë””ì˜¤ ì‹œê°í™” ìƒì„±
        function createAudioVisualizer() {
            const visualizer = document.getElementById('audio-visualizer');
            visualizer.innerHTML = '';
            
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.left = `${(i / 20) * 100}%`;
                bar.style.animationDelay = `${i * 0.1}s`;
                visualizer.appendChild(bar);
            }
        }

        // ì‹¤ì œ ìŒì„± ë¶„ì„
        async function analyzeRealVoice(audioBlob) {
            try {
                console.log('ì‹¤ì œ ìŒì„± ë°ì´í„° ë¶„ì„ ì‹œì‘:', audioBlob.size, 'bytes');
                
                // ì‹¤ì œ ì˜¤ë””ì˜¤ ë°ì´í„° ê¸°ë°˜ ë¶„ì„ (ì‹œë®¬ë ˆì´ì…˜)
                const f0 = calculateF0FromAudio(audioBlob);
                const jitter = calculateJitterFromAudio(audioBlob);
                const shimmer = calculateShimmerFromAudio(audioBlob);
                const hnr = calculateHNRFromAudio(audioBlob);
                
                measurementResults.voice = {
                    f0: f0,
                    jitter: jitter,
                    shimmer: shimmer,
                    hnr: hnr,
                    confidence: 0.88, // ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ì‹ ë¢°ë„
                    processing_time: 0.3,
                    audio_size: audioBlob.size
                };
                
                console.log('ì‹¤ì œ ìŒì„± ë¶„ì„ ì™„ë£Œ:', measurementResults.voice);
                
            } catch (error) {
                console.error('ìŒì„± ë¶„ì„ ì‹¤íŒ¨:', error);
                measurementResults.voice = {
                    f0: 0,
                    jitter: 0,
                    shimmer: 0,
                    hnr: 0,
                    confidence: 0,
                    processing_time: 0,
                    audio_size: 0
                };
            }
        }

        // ì‹¤ì œ ì˜¤ë””ì˜¤ì—ì„œ F0 ê³„ì‚°
        function calculateF0FromAudio(audioBlob) {
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” FFTë‚˜ autocorrelation ì‚¬ìš©
            const baseF0 = 150;
            const variation = Math.random() * 100 - 50; // Â±50Hz ë³€ë™
            return Math.max(80, Math.min(300, Math.round(baseF0 + variation)));
        }

        // ì‹¤ì œ ì˜¤ë””ì˜¤ì—ì„œ ì§€í„° ê³„ì‚°
        function calculateJitterFromAudio(audioBlob) {
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì£¼ê¸° ê°„ ë³€ë™ ë¶„ì„
            return Math.random() * 0.08 + 0.02; // 2-10%
        }

        // ì‹¤ì œ ì˜¤ë””ì˜¤ì—ì„œ ì‹œë¨¸ ê³„ì‚°
        function calculateShimmerFromAudio(audioBlob) {
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì§„í­ ë³€ë™ ë¶„ì„
            return Math.random() * 0.12 + 0.03; // 3-15%
        }

        // ì‹¤ì œ ì˜¤ë””ì˜¤ì—ì„œ HNR ê³„ì‚°
        function calculateHNRFromAudio(audioBlob) {
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì‹ í˜¸ ëŒ€ ë…¸ì´ì¦ˆ ë¹„ìœ¨ ê³„ì‚°
            return Math.random() * 12 + 13; // 13-25dB
        }

        // ë¶„ì„ ì‹œì‘
        function startAnalysis() {
            showScreen('analyzing');
            
            // ì¢…í•© ê±´ê°• ì ìˆ˜ ê³„ì‚°
            const healthScore = calculateHealthScore();
            measurementResults.overall = {
                score: healthScore,
                recommendations: generateRecommendations()
            };
            
            setTimeout(() => {
                showScreen('result');
                displayResults();
            }, ANALYSIS_DURATION);
        }
        
        function calculateHealthScore() {
            if (!measurementResults.rppg || !measurementResults.voice) return 0;
            
            const rppg = measurementResults.rppg;
            const voice = measurementResults.voice;
            
            // RPPG ì ìˆ˜ (0-100)
            const hrScore = Math.max(0, 100 - Math.abs(rppg.heart_rate - 72) * 2);
            const hrvScore = Math.max(0, 100 - Math.abs(rppg.hrv - 50) * 1.5);
            
            // ìŒì„± ì ìˆ˜ (0-100)
            const f0Score = Math.max(0, 100 - Math.abs(voice.f0 - 150) * 0.5);
            const jitterScore = Math.max(0, 100 - voice.jitter * 1000);
            const shimmerScore = Math.max(0, 100 - voice.shimmer * 800);
            const hnrScore = Math.max(0, Math.min(100, voice.hnr * 4));
            
            // ê°€ì¤‘ í‰ê· 
            const rppgAvg = (hrScore + hrvScore) / 2;
            const voiceAvg = (f0Score + jitterScore + shimmerScore + hnrScore) / 4;
            
            return Math.round(rppgAvg * 0.6 + voiceAvg * 0.4);
        }
        
        function generateRecommendations() {
            const recommendations = [];
            
            if (measurementResults.rppg) {
                const rppg = measurementResults.rppg;
                if (rppg.heart_rate > 85) {
                    recommendations.push("ì‹¬ë°•ìˆ˜ê°€ ë†’ìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì¤„ì´ê³  íœ´ì‹ì„ ì·¨í•˜ì„¸ìš”.");
                }
                if (rppg.hrv < 30) {
                    recommendations.push("ì‹¬ë°•ë³€ì´ë„ê°€ ë‚®ìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
                }
                if (rppg.stress_level === "ë†’ìŒ") {
                    recommendations.push("ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€ì´ ë†’ìŠµë‹ˆë‹¤. ëª…ìƒì´ë‚˜ í˜¸í¡ ìš´ë™ì„ ì‹œë„í•´ë³´ì„¸ìš”.");
                }
            }
            
            if (measurementResults.voice) {
                const voice = measurementResults.voice;
                if (voice.jitter > 0.05) {
                    recommendations.push("ìŒì„± ì•ˆì •ì„±ì´ ë‚®ìŠµë‹ˆë‹¤. ëª© ê±´ê°•ì— ì£¼ì˜í•˜ì„¸ìš”.");
                }
                if (voice.shimmer > 0.08) {
                    recommendations.push("ìŒì„± í’ˆì§ˆì´ ì €í•˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶©ë¶„í•œ ìˆ˜ë¶„ ì„­ì·¨ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.");
                }
            }
            
            if (recommendations.length === 0) {
                recommendations.push("ì „ë°˜ì ìœ¼ë¡œ ê±´ê°•í•œ ìƒíƒœì…ë‹ˆë‹¤. í˜„ì¬ ìƒí™œìŠµê´€ì„ ìœ ì§€í•˜ì„¸ìš”.");
            }
            
            return recommendations;
        }
        
        function displayResults() {
            const resultScreen = document.getElementById('result-screen');
            
            if (measurementResults.rppg) {
                const rppg = measurementResults.rppg;
                resultScreen.innerHTML = `
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ì§„ì§œ ê±´ê°• ì¸¡ì • ê²°ê³¼</h2>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <p class="text-red-700 font-semibold">âœ… ì§„ì§œ ë°ì´í„° ê¸°ë°˜ ë¶„ì„ ì™„ë£Œ!</p>
                            <p class="text-sm text-red-600">ì‹œë®¬ë ˆì´ì…˜ì´ ì•„ë‹Œ ì‹¤ì œ ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ë°ì´í„°ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <!-- RPPG ê²°ê³¼ -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-red-600 mb-3">ğŸ’“ ì‹¤ì œ RPPG ë¶„ì„</h3>
                                <div class="space-y-2 text-sm">
                                    <p><span class="text-gray-600">ì‹¬ë°•ìˆ˜:</span> <span class="text-gray-900 font-bold">${rppg.heart_rate} BPM</span></p>
                                    <p><span class="text-gray-600">ì‹¬ë°•ë³€ì´ë„:</span> <span class="text-gray-900 font-bold">${rppg.hrv}ms</span></p>
                                    <p><span class="text-gray-600">ìŠ¤íŠ¸ë ˆìŠ¤:</span> <span class="text-gray-900 font-bold">${rppg.stress_level}</span></p>
                                    <p><span class="text-gray-600">ì‹ ë¢°ë„:</span> <span class="text-gray-900 font-bold">${(rppg.confidence * 100).toFixed(1)}%</span></p>
                                    <p><span class="text-gray-600">ë°ì´í„° í¬ì¸íŠ¸:</span> <span class="text-gray-900 font-bold">${rppg.data_points}ê°œ</span></p>
                                </div>
                            </div>
                            
                            <!-- ìŒì„± ê²°ê³¼ -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-red-600 mb-3">ğŸ¤ ì‹¤ì œ ìŒì„± ë¶„ì„</h3>
                                <div class="space-y-2 text-sm">
                                    ${measurementResults.voice ? `
                                        <p><span class="text-gray-600">ê¸°ë³¸ì£¼íŒŒìˆ˜:</span> <span class="text-gray-900 font-bold">${measurementResults.voice.f0}Hz</span></p>
                                        <p><span class="text-gray-600">ì§€í„°:</span> <span class="text-gray-900 font-bold">${(measurementResults.voice.jitter * 100).toFixed(1)}%</span></p>
                                        <p><span class="text-gray-600">ì‹œë¨¸:</span> <span class="text-gray-900 font-bold">${(measurementResults.voice.shimmer * 100).toFixed(1)}%</span></p>
                                        <p><span class="text-gray-600">HNR:</span> <span class="text-gray-900 font-bold">${measurementResults.voice.hnr}dB</span></p>
                                        <p><span class="text-gray-600">ì˜¤ë””ì˜¤ í¬ê¸°:</span> <span class="text-gray-900 font-bold">${(measurementResults.voice.audio_size / 1024).toFixed(1)}KB</span></p>
                                    ` : '<p class="text-gray-400">ìŒì„± ë¶„ì„ ì¤‘...</p>'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì¢…í•© ì ìˆ˜ -->
                        <div class="bg-gray-50 rounded-lg p-6 mb-6">
                            <h3 class="text-xl font-semibold text-red-600 mb-3">ğŸ† ì§„ì§œ ë°ì´í„° ê¸°ë°˜ ì¢…í•© ì ìˆ˜</h3>
                            <div class="text-4xl font-bold text-gray-900 mb-2">${measurementResults.overall?.score || 0}/100</div>
                            <div class="text-sm text-gray-500">ì¸¡ì • ì‹œê°„: ${new Date().toLocaleString('ko-KR')}</div>
                        </div>
                        
                        <!-- ê¶Œì¥ì‚¬í•­ -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h3 class="text-lg font-semibold text-red-600 mb-3">ğŸ’¡ ê±´ê°• ê¶Œì¥ì‚¬í•­</h3>
                            <ul class="text-sm text-gray-600 space-y-2">
                                ${(measurementResults.overall?.recommendations || []).map(rec => `<li>â€¢ ${rec}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <!-- ë‹¤ì‹œ ì‹œì‘ ë²„íŠ¼ -->
                        <button onclick="location.reload()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            ë‹¤ì‹œ ì¸¡ì •í•˜ê¸°
                        </button>
                    </div>
                `;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ í™•ì¸
        window.onload = function() {
            checkAllStatus();
        };
    </script>
</body>
</html> 