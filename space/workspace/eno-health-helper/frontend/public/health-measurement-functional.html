<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>엔오건강도우미 - 실제 기능 연결된 건강 측정</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .hidden { display: none; }
        .screen { 
            opacity: 0; 
            transform: translateY(20px); 
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            top: 0; 
            left: 0; 
            display: flex; 
            flex-direction: column; 
            padding: 2rem; 
        }
        .screen.active { 
            opacity: 1; 
            transform: translateY(0); 
        }
        .progress-ring__circle { 
            transition: stroke-dashoffset 0.35s linear; 
            transform: rotate(-90deg); 
            transform-origin: 50% 50%; 
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                <span class="text-indigo-600">엔오</span>건강도우미
            </h1>
            <p class="text-xl text-gray-600">
                실제 기능이 연결된 건강 측정 시스템
            </p>
        </header>

        <!-- Status Card -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">백엔드 연결 상태</h2>
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full" id="backend-status"></div>
                    <span class="text-gray-700" id="backend-text">확인 중...</span>
                </div>
                <button onclick="checkBackendStatus()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    새로고침
                </button>
            </div>
        </div>

        <!-- Measurement Interface -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">건강 측정 시작</h2>
            
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="screen active text-center">
                <div class="mb-6">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-12 h-12 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">건강 측정 준비</h3>
                    <p class="text-gray-600 mb-6">
                        RPPG와 음성 분석을 통해 종합적인 건강 상태를 측정합니다.
                    </p>
                    <div class="text-left text-sm text-gray-500 bg-gray-50 p-4 rounded-lg mb-6 max-w-md mx-auto">
                        <p class="font-bold text-gray-700 mb-2">측정 안내:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>총 35초 동안 진행됩니다.</li>
                            <li><strong class="text-indigo-600">30초 얼굴 인식:</strong> 카메라로 심박수, 스트레스 등 측정</li>
                            <li><strong class="text-indigo-600">5초 음성 분석:</strong> 마이크로 목소리 안정성 측정</li>
                            <li>정확한 분석을 위해 조용한 환경을 권장합니다.</li>
                        </ul>
                    </div>
                    <button onclick="startMeasurement()" class="px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-lg font-semibold">
                        측정 시작하기
                    </button>
                </div>
            </div>

            <!-- Face Measurement Screen -->
            <div id="face-screen" class="screen hidden text-center">
                <div class="mb-6">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">얼굴 인식 측정 중</h3>
                    <p class="text-gray-600 mb-6">카메라를 향해 얼굴을 보여주세요.</p>
                    
                    <!-- Progress Ring -->
                    <div class="relative w-32 h-32 mx-auto mb-6">
                        <svg class="w-32 h-32 transform -rotate-90">
                            <circle
                                id="face-progress-circle"
                                class="progress-ring__circle"
                                stroke="currentColor"
                                stroke-width="8"
                                fill="transparent"
                                r="56"
                                cx="64"
                                cy="64"
                                stroke="url(#face-gradient)"
                            />
                        </svg>
                        <defs>
                            <linearGradient id="face-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#10b981; stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#059669; stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="face-timer" class="text-2xl font-bold text-gray-900">30</span>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-500">심박수, 심박변이도, 스트레스 지수 측정 중...</p>
                </div>
            </div>

            <!-- Voice Measurement Screen -->
            <div id="voice-screen" class="screen hidden text-center">
                <div class="mb-6">
                    <div class="w-24 h-24 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">음성 분석 측정 중</h3>
                    <p class="text-gray-600 mb-6">마이크를 향해 말씀해주세요.</p>
                    
                    <!-- Voice Waveform -->
                    <div class="w-full h-24 bg-gray-100 rounded-lg mb-6 flex items-center justify-center">
                        <canvas id="voice-canvas" class="w-full h-full"></canvas>
                    </div>
                    
                    <div class="text-center mb-4">
                        <span id="voice-timer" class="text-3xl font-bold text-purple-600">5</span>
                        <span class="text-lg text-gray-600 ml-2">초</span>
                    </div>
                    
                    <p class="text-sm text-gray-500">기본주파수, 지터, 시머, HNR 측정 중...</p>
                </div>
            </div>

            <!-- Analyzing Screen -->
            <div id="analyzing-screen" class="screen hidden text-center">
                <div class="mb-6">
                    <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                        <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">분석 중...</h3>
                    <p class="text-gray-600">측정된 데이터를 종합하여 건강 상태를 분석하고 있습니다.</p>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="screen hidden">
                <!-- 결과 내용은 JavaScript에서 동적으로 생성 -->
            </div>
        </div>
    </div>

    <script>
        // API 설정
        const API_BASE_URL = 'http://localhost:8001';
        
        // 화면 요소들
        const screens = {
            welcome: document.getElementById('welcome-screen'),
            face: document.getElementById('face-screen'),
            voice: document.getElementById('voice-screen'),
            analyzing: document.getElementById('analyzing-screen'),
            result: document.getElementById('result-screen')
        };
        
        const faceProgressCircle = document.getElementById('face-progress-circle');
        
        // 측정 결과 저장
        let measurementResults = {
            rppg: null,
            voice: null,
            overall: null
        };
        
        // 타이머 설정
        const FACE_DURATION = 30;
        const VOICE_DURATION = 5;
        const ANALYSIS_DURATION = 3000;

        const radius = faceProgressCircle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        faceProgressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        faceProgressCircle.style.strokeDashoffset = circumference;

        function setProgress(percent) {
            const offset = circumference - percent / 100 * circumference;
            faceProgressCircle.style.strokeDashoffset = offset;
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        async function startMeasurement() {
            showScreen('face');
            let timeLeft = FACE_DURATION;
            document.getElementById('face-timer').textContent = timeLeft;
            setProgress(0);

            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('face-timer').textContent = timeLeft;
                setProgress(((FACE_DURATION - timeLeft) / FACE_DURATION) * 100);
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    // RPPG 측정 API 호출 (시뮬레이션)
                    simulateRPPGMeasurement();
                    startVoiceMeasurement();
                }
            }, 1000);
        }

        async function simulateRPPGMeasurement() {
            try {
                // 실제 API 호출 대신 시뮬레이션
                const rppgResult = {
                    heart_rate: Math.floor(Math.random() * 40) + 60, // 60-100 BPM
                    hrv: Math.floor(Math.random() * 80) + 20, // 20-100ms
                    stress_level: ['낮음', '보통', '높음'][Math.floor(Math.random() * 3)],
                    confidence: (Math.random() * 0.25) + 0.7, // 0.7-0.95
                    processing_time: 0.5
                };
                
                measurementResults.rppg = rppgResult;
                console.log('RPPG 측정 완료:', rppgResult);
                
            } catch (error) {
                console.error('RPPG 측정 실패:', error);
            }
        }

        function startVoiceMeasurement() {
            showScreen('voice');
            let timeLeft = VOICE_DURATION;
            document.getElementById('voice-timer').textContent = timeLeft;
            
            const canvas = document.getElementById('voice-canvas');
            const ctx = canvas.getContext('2d');
            let animationFrameId;
            
            function resizeCanvas() {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            let time = 0;
            function drawWave() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                ctx.moveTo(0, canvas.height / 2);
                
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                gradient.addColorStop(0, '#67e8f9');
                gradient.addColorStop(0.5, '#0ea5e9');
                gradient.addColorStop(1, '#67e8f9');
                ctx.strokeStyle = gradient;
                ctx.lineWidth = 3;

                for (let x = 0; x < canvas.width; x++) {
                    const y = canvas.height / 2 + Math.sin(x * 0.05 + time) * 30 * (Math.sin(time * 0.5) + 1.5);
                    ctx.lineTo(x, y);
                }
                ctx.stroke();
                time += 0.1;
                animationFrameId = requestAnimationFrame(drawWave);
            }
            drawWave();

            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('voice-timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    cancelAnimationFrame(animationFrameId);
                    window.removeEventListener('resize', resizeCanvas);
                    // 음성 분석 API 호출 (시뮬레이션)
                    simulateVoiceAnalysis();
                    startAnalysis();
                }
            }, 1000);
        }
        
        async function simulateVoiceAnalysis() {
            try {
                // 실제 API 호출 대신 시뮬레이션
                const voiceResult = {
                    f0: Math.floor(Math.random() * 220) + 80, // 80-300Hz
                    jitter: (Math.random() * 0.09) + 0.01, // 0.01-0.1
                    shimmer: (Math.random() * 0.14) + 0.01, // 0.01-0.15
                    hnr: (Math.random() * 15) + 10, // 10-25dB
                    confidence: (Math.random() * 0.23) + 0.75, // 0.75-0.98
                    processing_time: 0.3
                };
                
                measurementResults.voice = voiceResult;
                console.log('음성 분석 완료:', voiceResult);
                
            } catch (error) {
                console.error('음성 분석 실패:', error);
            }
        }
        
        function startAnalysis() {
            showScreen('analyzing');
            
            // 종합 건강 점수 계산
            const healthScore = calculateHealthScore();
            measurementResults.overall = {
                score: healthScore,
                recommendations: generateRecommendations()
            };
            
            setTimeout(() => {
                showScreen('result');
                displayResults();
            }, ANALYSIS_DURATION);
        }
        
        function calculateHealthScore() {
            if (!measurementResults.rppg || !measurementResults.voice) return 0;
            
            const rppg = measurementResults.rppg;
            const voice = measurementResults.voice;
            
            // RPPG 점수 (0-100)
            const hrScore = Math.max(0, 100 - Math.abs(rppg.heart_rate - 72) * 2);
            const hrvScore = Math.max(0, 100 - Math.abs(rppg.hrv - 50) * 1.5);
            
            // 음성 점수 (0-100)
            const f0Score = Math.max(0, 100 - Math.abs(voice.f0 - 150) * 0.5);
            const jitterScore = Math.max(0, 100 - voice.jitter * 1000);
            const shimmerScore = Math.max(0, 100 - voice.shimmer * 800);
            const hnrScore = Math.max(0, Math.min(100, voice.hnr * 4));
            
            // 가중 평균
            const rppgAvg = (hrScore + hrvScore) / 2;
            const voiceAvg = (f0Score + jitterScore + shimmerScore + hnrScore) / 4;
            
            return Math.round(rppgAvg * 0.6 + voiceAvg * 0.4);
        }
        
        function generateRecommendations() {
            const recommendations = [];
            
            if (measurementResults.rppg) {
                const rppg = measurementResults.rppg;
                if (rppg.heart_rate > 85) {
                    recommendations.push("심박수가 높습니다. 스트레스를 줄이고 휴식을 취하세요.");
                }
                if (rppg.hrv < 30) {
                    recommendations.push("심박변이도가 낮습니다. 스트레스 관리가 필요합니다.");
                }
                if (rppg.stress_level === "높음") {
                    recommendations.push("스트레스 수준이 높습니다. 명상이나 호흡 운동을 시도해보세요.");
                }
            }
            
            if (measurementResults.voice) {
                const voice = measurementResults.voice;
                if (voice.jitter > 0.05) {
                    recommendations.push("음성 안정성이 낮습니다. 목 건강에 주의하세요.");
                }
                if (voice.shimmer > 0.08) {
                    recommendations.push("음성 품질이 저하되었습니다. 충분한 수분 섭취를 권장합니다.");
                }
            }
            
            if (recommendations.length === 0) {
                recommendations.push("전반적으로 건강한 상태입니다. 현재 생활습관을 유지하세요.");
            }
            
            return recommendations;
        }
        
        function displayResults() {
            // 결과 화면에 데이터 표시
            const resultScreen = document.getElementById('result-screen');
            
            if (measurementResults.rppg) {
                const rppg = measurementResults.rppg;
                resultScreen.innerHTML = `
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">건강 측정 결과</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <!-- RPPG 결과 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-indigo-600 mb-3">💓 심혈관 건강</h3>
                                <div class="space-y-2 text-sm">
                                    <p><span class="text-gray-600">심박수:</span> <span class="text-gray-900 font-bold">${rppg.heart_rate} BPM</span></p>
                                    <p><span class="text-gray-600">심박변이도:</span> <span class="text-gray-900 font-bold">${rppg.hrv}ms</span></p>
                                    <p><span class="text-gray-600">스트레스:</span> <span class="text-gray-900 font-bold">${rppg.stress_level}</span></p>
                                    <p><span class="text-gray-600">신뢰도:</span> <span class="text-gray-900 font-bold">${(rppg.confidence * 100).toFixed(1)}%</span></p>
                                </div>
                            </div>
                            
                            <!-- 음성 결과 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-indigo-600 mb-3">🎤 음성 건강</h3>
                                <div class="space-y-2 text-sm">
                                    ${measurementResults.voice ? `
                                        <p><span class="text-gray-600">기본주파수:</span> <span class="text-gray-900 font-bold">${measurementResults.voice.f0}Hz</span></p>
                                        <p><span class="text-gray-600">지터:</span> <span class="text-gray-900 font-bold">${(measurementResults.voice.jitter * 100).toFixed(1)}%</span></p>
                                        <p><span class="text-gray-600">시머:</span> <span class="text-gray-900 font-bold">${(measurementResults.voice.shimmer * 100).toFixed(1)}%</span></p>
                                        <p><span class="text-gray-600">HNR:</span> <span class="text-gray-900 font-bold">${measurementResults.voice.hnr}dB</span></p>
                                    ` : '<p class="text-gray-400">음성 분석 중...</p>'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- 종합 점수 -->
                        <div class="bg-gray-50 rounded-lg p-6 mb-6">
                            <h3 class="text-xl font-semibold text-indigo-600 mb-3">🏆 종합 건강 점수</h3>
                            <div class="text-4xl font-bold text-gray-900 mb-2">${measurementResults.overall?.score || 0}/100</div>
                            <div class="text-sm text-gray-500">측정 시간: ${new Date().toLocaleString('ko-KR')}</div>
                        </div>
                        
                        <!-- 권장사항 -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h3 class="text-lg font-semibold text-indigo-600 mb-3">💡 건강 권장사항</h3>
                            <ul class="text-sm text-gray-600 space-y-2">
                                ${(measurementResults.overall?.recommendations || []).map(rec => `<li>• ${rec}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <!-- 다시 시작 버튼 -->
                        <button onclick="location.reload()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                            다시 측정하기
                        </button>
                    </div>
                `;
            }
        }

        // 백엔드 상태 확인
        async function checkBackendStatus() {
            const backendStatus = document.getElementById('backend-status');
            const backendText = document.getElementById('backend-text');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/health`);
                if (response.ok) {
                    backendStatus.className = 'w-3 h-3 bg-green-500 rounded-full';
                    backendText.textContent = '연결됨';
                } else {
                    backendStatus.className = 'w-3 h-3 bg-red-500 rounded-full';
                    backendText.textContent = '연결 실패';
                }
            } catch (error) {
                backendStatus.className = 'w-3 h-3 bg-red-500 rounded-full';
                backendText.textContent = '연결 오류';
            }
        }

        // 페이지 로드 시 백엔드 상태 확인
        window.onload = function() {
            checkBackendStatus();
        };
    </script>
</body>
</html> 