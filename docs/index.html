<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—”ì˜¤ê±´ê°•ë„ìš°ë¯¸ - ê±´ê°• ì¸¡ì • v6 (ê°œì¸ì •ë³´ë³´í˜¸ ê°•í™”)</title>
         <script src="https://cdn.tailwindcss.com"></script>
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     <!-- Firebase SDK -->
     <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
     <!-- Kakao SDK -->
     <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
     <script>
         // Gemini API ì„¤ì •
         const GEMINI_API_KEY = 'AIzaSyA9VEvkeCqUO4je5G2eILmQSS-eWQRy4vc';
         const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
         
         // Firebase ì„¤ì •
         const firebaseConfig = {
             apiKey: "AIzaSyA9VEvkeCqUO4je5G2eILmQSS-eWQRy4vc",
             authDomain: "eno-health-helper.firebaseapp.com",
             projectId: "eno-health-helper",
             storageBucket: "eno-health-helper.appspot.com",
             messagingSenderId: "123456789",
             appId: "1:123456789:web:abcdef123456"
         };
         
         // Firebase ì´ˆê¸°í™”
         firebase.initializeApp(firebaseConfig);
         
         // Kakao ì´ˆê¸°í™”
         Kakao.init('YOUR_KAKAO_APP_KEY'); // ì‹¤ì œ Kakao ì•± í‚¤ë¡œ êµì²´ í•„ìš”
         
         console.log('âœ… Firebase ë° Kakao SDKê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
     </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: radial-gradient(ellipse at bottom, #1e3a8a 0%, #020617 70%);
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        
        .screen {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            padding: 2rem; /* 32px */
            pointer-events: none; 
        }
        .screen.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .glassmorphism {
            background: rgba(15, 23, 42, 0.6); /* slate-900/60 */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.2); /* sky-400/20 */
        }
        .neon-glow {
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.2), 0 0 30px rgba(56, 189, 248, 0.15);
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .face-outline-gradient {
            stroke: url(#face-gradient);
            stroke-dasharray: 1000;
            animation: dash 5s linear infinite;
        }
        @keyframes dash {
            from { stroke-dashoffset: 2000; }
            to { stroke-dashoffset: 0; }
        }
        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, transparent, #0ea5e9, transparent);
            box-shadow: 0 0 10px #0ea5e9;
            animation: scan 4s ease-in-out infinite;
        }
        @keyframes scan {
            0%, 100% { top: 10%; }
            50% { top: 90%; }
        }
        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
        /* ë™ì˜ ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        button:disabled {
            background-color: #334155; /* slate-700 */
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* ì ìˆ˜ ì›í˜• í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .score-circle::before {
            content: '';
            position: absolute;
            inset: -5px;
            border-radius: 50%;
            background: conic-gradient(#0ea5e9 0% var(--score, 0%), transparent var(--score, 0%) 100%);
            -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 15px), #000 calc(100% - 14px));
            mask: radial-gradient(farthest-side, transparent calc(100% - 15px), #000 calc(100% - 14px));
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto glassmorphism rounded-2xl shadow-2xl neon-glow text-center relative overflow-hidden min-h-[650px]">

        <!-- í—¤ë”: ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ì ì •ë³´ -->
        <div class="absolute top-4 left-4 right-4 flex justify-between items-center z-10">
            <div class="text-left">
                <p class="text-sm text-gray-300">ì•ˆë…•í•˜ì„¸ìš”, ê²ŒìŠ¤íŠ¸ë‹˜</p>
            </div>
            <div class="flex space-x-2">
                                 <button id="header-login-btn" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded-lg transition-colors">
                     ë¡œê·¸ì¸
                 </button>
            </div>
        </div>

        <!-- 1. ì‹œì‘ í™”ë©´ -->
        <div id="welcome-screen" class="screen active flex-grow justify-center items-center">
            <div class="mb-6">
                <svg class="w-24 h-24 text-sky-400 mx-auto" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="icon-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#38bdf8; stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#0ea5e9; stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path d="M32 56C45.2548 56 56 45.2548 56 32C56 18.7452 45.2548 8 32 8C18.7452 8 8 18.7452 8 32C8 45.2548 18.7452 56 32 56Z" stroke="url(#icon-grad)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M32 18V32L42 37" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-white mb-3 font-orbitron">ì—”ì˜¤ê±´ê°•ë„ìš°ë¯¸</h1>
            <p class="text-gray-300 mb-8">MKM Labì˜ AI ê¸°ìˆ ë¡œ ë‹¹ì‹ ì˜ ê±´ê°•ì„ ì¸¡ì •í•©ë‹ˆë‹¤.</p>
            <button id="start-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-4 px-6 rounded-lg text-lg transition-all duration-300 transform hover:scale-105 shadow-lg shadow-sky-500/30">
                ì¸¡ì • ì‹œì‘í•˜ê¸°
            </button>
        </div>

        <!-- 1.5. (ì‹ ì„¤) ê°œì¸ì •ë³´ ë™ì˜ í™”ë©´ -->
        <div id="consent-screen" class="screen flex-grow justify-center items-center text-left">
            <h2 class="text-2xl font-bold mb-6 text-center font-orbitron">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜</h2>
            <div class="text-sm text-gray-300 bg-slate-800/50 p-4 rounded-lg mb-6 space-y-3 h-64 overflow-y-auto">
                <p class="font-bold">MKM Labì€ ê·€í•˜ì˜ ê°œì¸ì •ë³´ë¥¼ ì†Œì¤‘íˆ ë‹¤ë£¹ë‹ˆë‹¤.</p>
                <p>ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ìµœì†Œí•œì˜ ìƒì²´ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ë©°, ì´ëŠ” ê°œì¸ì •ë³´ ë³´í˜¸ë²• ë“± ê´€ë ¨ ë²•ë ¹ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.</p>
                <div>
                    <p class="font-semibold text-sky-300">1. ìˆ˜ì§‘ í•­ëª©:</p>
                    <p class="pl-2">- ì–¼êµ´ ì˜ìƒ ë°ì´í„° (30ì´ˆ)</p>
                    <p class="pl-2">- ìŒì„± ë°ì´í„° (5ì´ˆ)</p>
                </div>
                <div>
                    <p class="font-semibold text-sky-300">2. ìˆ˜ì§‘ ë° ì´ìš© ëª©ì :</p>
                    <p class="pl-2">- AI ê¸°ë°˜ ê±´ê°• ìƒíƒœ ë¶„ì„ (ì‹¬ë°•ìˆ˜, ìŠ¤íŠ¸ë ˆìŠ¤, ìŒì„± ì•ˆì •ì„± ë“±)</p>
                </div>
                <div>
                    <p class="font-semibold text-sky-300">3. ì²˜ë¦¬ ë° ë³´ìœ  ì›ì¹™:</p>
                    <p class="pl-2">- ìˆ˜ì§‘ëœ ì›ë³¸ ë°ì´í„°ëŠ” ì™¸ë¶€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•Šê³ , ê·€í•˜ì˜ ê¸°ê¸° ë‚´ì—ì„œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                    <p class="pl-2">- ë¶„ì„ì— ì‚¬ìš©ëœ ë°ì´í„°ëŠ” ê°œì¸ì„ ì‹ë³„í•  ìˆ˜ ì—†ëŠ” ë¹„ì‹ë³„ ë°ì´í„°ë¡œ ë³€í™˜ë˜ë©°, ë¶„ì„ ì™„ë£Œ í›„ ì¦‰ì‹œ íŒŒê¸°ë©ë‹ˆë‹¤.</p>
                    <p class="pl-2">- íšŒì›ê°€ì… ì‹œ, ê²°ê³¼ëŠ” ê·€í•˜ì˜ ë™ì˜ í•˜ì— ë³¸ì¸ì˜ ê³„ì •ì—ë§Œ ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
                </div>
            </div>
            <div class="flex items-center space-x-3 mb-8">
                <input type="checkbox" id="consent-checkbox" class="h-5 w-5 bg-slate-700 border-slate-500 text-sky-500 focus:ring-sky-500 rounded">
                <label for="consent-checkbox" class="text-gray-200">ìœ„ ë‚´ìš©ì— ëª¨ë‘ ë™ì˜í•©ë‹ˆë‹¤.</label>
            </div>
            <button id="agree-btn" class="w-full bg-sky-500 text-white font-bold py-4 px-6 rounded-lg text-lg transition-all" disabled>
                ë™ì˜í•˜ê³  ê³„ì†í•˜ê¸°
            </button>
        </div>

        <!-- 2. ì–¼êµ´ ì¸¡ì • í™”ë©´ -->
        <div id="face-screen" class="screen flex-grow justify-center items-center">
            <h2 class="text-2xl font-bold mb-2 font-orbitron">ì–¼êµ´ ì¸ì‹ ì¤‘...</h2>
            <p class="text-gray-300 mb-8">í™”ë©´ì˜ ê°€ì´ë“œë¼ì¸ì— ì–¼êµ´ì„ ë§ì¶°ì£¼ì„¸ìš”.</p>
            <div class="relative w-64 h-80 bg-slate-900/50 rounded-lg flex items-center justify-center mb-8 overflow-hidden">
                <div class="absolute inset-0 bg-black opacity-50"></div>
                <svg class="absolute inset-0 w-full h-full" viewBox="0 0 200 250" preserveAspectRatio="xMidYMid slice">
                    <defs>
                        <linearGradient id="face-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#0ea5e9;"/>
                            <stop offset="100%" style="stop-color:#67e8f9;"/>
                        </linearGradient>
                    </defs>
                    <ellipse class="face-outline-gradient" cx="100" cy="125" rx="80" ry="110" stroke-width="3" fill="none"/>
                </svg>
                <div class="scan-line"></div>
                <div class="absolute top-4 right-4">
                    <svg class="w-16 h-16" viewBox="0 0 120 120">
                        <circle class="text-slate-700" stroke-width="8" stroke="currentColor" fill="transparent" r="52" cx="60" cy="60"/>
                        <circle id="face-progress-circle" class="progress-ring__circle text-sky-400" stroke-width="8" stroke="currentColor" fill="transparent" r="52" cx="60" cy="60"/>
                    </svg>
                    <span id="face-timer-text" class="absolute inset-0 flex items-center justify-center text-xl font-bold font-orbitron">30</span>
                </div>
            </div>
            <p class="text-sm text-sky-300 animate-pulse">ì •í™•í•œ ì¸¡ì •ì„ ìœ„í•´ ì›€ì§ì´ì§€ ë§ˆì„¸ìš”.</p>
        </div>

        <!-- 2.5. ì „í™˜ í™”ë©´ -->
        <div id="transition-screen" class="screen flex-grow justify-center items-center">
            <div class="mb-8">
                <svg class="checkmark w-24 h-24 mx-auto" xmlns="
                
                
                
                
                
                
                
                
                
                
                
                http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" stroke="#0ea5e9" stroke-width="4"/>
                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" stroke="#0ea5e9" stroke-width="5" stroke-linecap="round"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2 font-orbitron">ì–¼êµ´ ì¸ì‹ ì™„ë£Œ</h2>
            <p class="text-gray-300">ë‹¤ìŒì€ ìŒì„± ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p>
        </div>

        <!-- 3. ìŒì„± ì¸¡ì • í™”ë©´ -->
        <div id="voice-screen" class="screen flex-grow justify-center items-center">
            <h2 class="text-2xl font-bold mb-2 font-orbitron">ìŒì„± ë¶„ì„ ì¤‘...</h2>
            <p class="text-gray-300 mb-8">5ì´ˆê°„ 'ì•„-' ì†Œë¦¬ë¥¼ í¸ì•ˆí•˜ê²Œ ë‚´ì£¼ì„¸ìš”.</p>
            <div class="w-64 h-80 bg-slate-900/50 rounded-lg flex items-center justify-center mb-8">
                <canvas id="voice-canvas" class="w-full h-full"></canvas>
                <div class="absolute top-4 right-4 text-xl font-bold font-orbitron bg-slate-900/50 px-3 py-1 rounded-md">
                    <span id="voice-timer-text">5</span>s
                </div>
            </div>
            <p class="text-sm text-sky-300 animate-pulse">ë§ˆì´í¬ì— ê°€ê¹ê²Œ ë°œì„±í•´ì£¼ì„¸ìš”.</p>
        </div>
        
        <!-- 4. ë¶„ì„ ì¤‘ í™”ë©´ -->
        <div id="analyzing-screen" class="screen flex-grow justify-center items-center">
             <div class="animate-spin rounded-full h-24 w-24 border-b-4 border-sky-400 mb-8"></div>
             <h2 class="text-2xl font-bold mb-4 font-orbitron">ë°ì´í„° ë¶„ì„ ì¤‘</h2>
             <p class="text-gray-300">ë‹¹ì‹ ì˜ ìƒì²´ ì‹ í˜¸ ì† ì˜ë¯¸ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- 5. ìƒì„¸ ê²°ê³¼ í™”ë©´ -->
        <div id="result-screen" class="screen flex-grow justify-center items-start text-left">
            <div class="w-full">
                                 <!-- Header -->
                 <header class="text-center mb-8">
                     <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-sky-300 font-orbitron neon-glow mb-3">AI ê±´ê°• ë¶„ì„ ê²°ê³¼</h2>
                     <p class="text-sm sm:text-base lg:text-lg text-gray-300">2025ë…„ 8ì›” 27ì¼ 09:00 ì¸¡ì •</p>
                 </header>

                                 <!-- Main Results -->
                 <div class="w-full glassmorphism rounded-2xl p-4 sm:p-6 mb-6">
                     <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-white mb-6 text-center">ì¢…í•© ê±´ê°• ëŒ€ì‹œë³´ë“œ</h3>
                                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8 items-center">
                         <!-- Score Circle -->
                         <div class="flex justify-center mb-6 lg:mb-0">
                             <div class="score-circle glassmorphism w-40 h-40 lg:w-48 lg:h-48" style="--score: 82%">
                                 <div class="text-center">
                                     <p class="text-3xl lg:text-4xl xl:text-5xl font-black text-white font-orbitron">82</p>
                                     <p class="text-xs lg:text-sm xl:text-base font-semibold text-sky-400">ì¢…í•© ì ìˆ˜</p>
                                 </div>
                             </div>
                         </div>
                         <!-- Radar Chart -->
                         <div class="h-48 lg:h-64 xl:h-80 w-full">
                             <canvas id="coreMetricsChart"></canvas>
                         </div>
                     </div>

                                         <!-- Sasang Constitution -->
                     <div class="mt-8 text-center">
                         <h4 class="text-lg sm:text-xl lg:text-2xl font-bold text-white mb-4">AI ë¶„ì„: ë‹¹ì‹ ì˜ ì‚¬ìƒì²´ì§ˆ (ì¶”ì •)</h4>
                         <div id="sasang-type-display" class="inline-block bg-sky-500/20 text-sky-300 font-bold py-3 px-6 rounded-full mt-4 text-base sm:text-lg lg:text-xl">
                             ë¶„ì„ ì¤‘...
                         </div>
                         <p id="sasang-description" class="text-gray-300 max-w-xl mx-auto mt-4 text-sm sm:text-base">
                             ìƒì²´ ì‹ í˜¸ë¥¼ ë¶„ì„í•˜ì—¬ ì‚¬ìƒì²´ì§ˆì„ ë¶„ë¥˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                         </p>
                         <div id="sasang-confidence" class="text-sm text-sky-400 mt-2">
                             ì‹ ë¢°ë„: ê³„ì‚° ì¤‘...
                         </div>
                     </div>
                    
                                         <!-- Health Advice -->
                     <div id="health-advice-section" class="mt-6 hidden">
                         <h5 class="text-lg sm:text-xl font-bold text-white mb-4 text-center">ì²´ì§ˆë³„ ê±´ê°• ì¡°ì–¸</h5>
                         <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 lg:gap-4">
                             <div class="bg-slate-800/50 p-3 lg:p-4 rounded-lg">
                                 <h6 class="font-semibold text-sky-300 mb-2 text-center lg:text-left text-sm lg:text-base">ğŸƒâ€â™‚ï¸ ìš´ë™</h6>
                                 <p id="exercise-advice" class="text-gray-300 text-center lg:text-left text-sm lg:text-base leading-relaxed"></p>
                             </div>
                             <div class="bg-slate-800/50 p-3 lg:p-4 rounded-lg">
                                 <h6 class="font-semibold text-sky-300 mb-2 text-center lg:text-left text-sm lg:text-base">ğŸ½ï¸ ì‹ì´</h6>
                                 <p id="diet-advice" class="text-gray-300 text-center lg:text-left text-sm lg:text-base leading-relaxed"></p>
                             </div>
                             <div class="bg-slate-800/50 p-3 lg:p-4 rounded-lg sm:col-span-2 lg:col-span-1">
                                 <h6 class="font-semibold text-sky-300 mb-2 text-center lg:text-left text-sm lg:text-base">ğŸ’¡ ìƒí™œ</h6>
                                 <p id="lifestyle-advice" class="text-gray-300 text-center lg:text-left text-sm lg:text-base leading-relaxed"></p>
                             </div>
                         </div>
                     </div>
                    
                                         <!-- Details Accordion -->
                     <div class="mt-6">
                         <details class="bg-slate-800/50 rounded-lg">
                             <summary class="p-4 cursor-pointer font-semibold text-white text-base sm:text-lg">ìƒì„¸ ìƒì²´ ì§€í‘œ ë³´ê¸°</summary>
                             <div class="p-4 border-t border-sky-500/20">
                                 <table class="w-full text-sm sm:text-base text-left">
                                    <thead class="text-sm sm:text-base text-sky-400 uppercase font-semibold">
                                         <tr><th class="py-3 px-2">êµ¬ë¶„</th><th class="py-3 px-2">ì§€í‘œ</th><th class="py-3 px-2">ì¸¡ì •ê°’</th><th class="py-3 px-2">ìƒíƒœ</th></tr>
                                    </thead>
                                    <tbody class="text-gray-300">
                                         <tr class="border-b border-gray-700"><td rowspan="4" class="py-3 px-2 font-semibold text-sky-200">rPPG (ì–¼êµ´)</td><td class="py-2 px-2">ì‹¬ë°•ìˆ˜</td><td class="py-2 px-2">68 BPM</td><td class="py-2 px-2 text-green-400 font-medium">ì•ˆì •</td></tr>
                                         <tr class="border-b border-gray-700"><td class="py-2 px-2">í˜ˆì•• (ì¶”ì •)</td><td class="py-2 px-2">115/75 mmHg</td><td class="py-2 px-2 text-green-400 font-medium">ì •ìƒ</td></tr>
                                         <tr class="border-b border-gray-700"><td class="py-2 px-2">ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜</td><td class="py-2 px-2">25 (ë‚®ìŒ)</td><td class="py-2 px-2 text-green-400 font-medium">ì•ˆì •</td></tr>
                                         <tr class="border-b border-gray-700"><td class="py-2 px-2">ì‹¬ë°•ë³€ì´ë„(HRV)</td><td class="py-2 px-2">55 ms</td><td class="py-2 px-2 text-green-400 font-medium">ì¢‹ìŒ</td></tr>
                                         <tr class="border-b border-gray-700"><td rowspan="3" class="py-3 px-2 font-semibold text-sky-200">ìŒì„±</td><td class="py-2 px-2">Jitter (ì£¼íŒŒìˆ˜ ë³€ë™ë¥ )</td><td class="py-2 px-2">0.8%</td><td class="py-2 px-2 text-green-400 font-medium">ì•ˆì •</td></tr>
                                         <tr class="border-b border-gray-700"><td class="py-2 px-2">Shimmer (ì§„í­ ë³€ë™ë¥ )</td><td class="py-2 px-2">2.5%</td><td class="py-2 px-2 text-green-400 font-medium">ì•ˆì •</td></tr>
                                         <tr><td class="py-2 px-2">HNR (ë°°ìŒ ëŒ€ ì¡ìŒë¹„)</td><td class="py-2 px-2">22 dB</td><td class="py-2 px-2 text-green-400 font-medium">ì¢‹ìŒ</td></tr>
                                    </tbody>
                                 </table>
                             </div>
                         </details>
                     </div>
                    
                                         <!-- AI Q&A Section -->
                     <div class="mt-6 glassmorphism rounded-2xl p-4 lg:p-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                             <h5 class="text-lg lg:text-xl font-bold text-white">ğŸ¤– AIì—ê²Œ ê±´ê°• ì§ˆë¬¸í•˜ê¸°</h5>
                             <span class="text-xs lg:text-sm font-semibold bg-yellow-500/20 text-yellow-300 py-1 px-3 rounded-full">10íšŒ ë¬´ë£Œ</span>
                         </div>
                         <div id="ai-answer" class="bg-slate-800/50 p-3 lg:p-4 rounded-lg min-h-[80px] text-gray-300 mb-4">
                             <p class="text-sm lg:text-base">ì•ˆë…•í•˜ì„¸ìš”! ë‹¹ì‹ ì˜ ê±´ê°• ë°ì´í„°ì™€ ì²´ì§ˆì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´, "ì œ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ê°€ ë‚®ì€ í¸ì¸ê°€ìš”?" ë˜ëŠ” "ì†Œì–‘ì¸ ì²´ì§ˆì— ì¢‹ì€ ìŒì‹ì€?" ê°™ì€ ì§ˆë¬¸ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                         </div>
                         <div class="flex flex-col lg:flex-row gap-3 lg:gap-4">
                             <textarea id="user-question" class="w-full lg:flex-1 bg-slate-800/50 p-3 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-sky-500 focus:outline-none resize-none text-sm lg:text-base" rows="3" placeholder="ì—¬ê¸°ì— ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                             <button id="send-question-btn" class="w-full lg:w-auto bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:from-sky-600 hover:to-blue-700 transition-all duration-300 shadow-lg hover:shadow-sky-500/50 self-end text-sm lg:text-base">
                                 ì „ì†¡
                             </button>
                         </div>
                     </div>
                </div>

                                                                   <!-- Action Buttons -->
                  <div class="flex flex-col lg:flex-row gap-3 lg:gap-4">
                       <button id="signup-btn" class="w-full bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 lg:py-4 px-6 lg:px-8 rounded-lg hover:from-sky-600 hover:to-blue-700 transition-all duration-300 shadow-lg hover:shadow-sky-500/50 text-sm lg:text-base">
                          ê¸°ë¡ ì €ì¥í•˜ê¸° (íšŒì›ê°€ì…)
                       </button>
                       <button class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 lg:py-4 px-6 lg:px-8 rounded-lg transition-colors duration-300 text-sm lg:text-base">
                          ë‹¤ì‹œ ì¸¡ì •í•˜ê¸°
                       </button>
                  </div>
            </div>
        </div>

        <!-- 6. ì¸ì¦ í™”ë©´ -->
        <div id="auth-screen" class="screen flex-grow justify-center items-center">
            <div class="w-full">
                <h2 class="text-2xl font-bold text-white text-center mb-6 font-orbitron">ì‹œì‘í•˜ê¸°</h2>
                
                <div class="space-y-4">
                                         <button id="google-login-btn" class="w-full flex items-center justify-center space-x-2 bg-white text-black font-bold py-3 rounded-lg transition hover:bg-gray-200">
                         <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M6.306 14.691L22.669 29.835c-2.133 1.866-4.962 3-8.169 3c-6.627 0-12-5.373-12-12c0-2.933 1.045-5.624 2.796-7.789l-5.495-5.495A19.954 19.954 0 0 0 4 24c0 6.959 3.548 13.014 8.951 16.639l-7.645-7.645z"></path><path fill="#FBBC05" d="M22.669 18.165l-5.657 5.657C16.154 26.158 16 27.042 16 28s.154 1.842.331 2.669l5.657-5.657l-5.656-5.657z"></path><path fill="#EA4335" d="M43.611 20.083L24 40l-5.657-5.657c2.118-1.866 3.849-4.421 4.669-7.331H42v-8z"></path></svg>
                         <span>Google ê³„ì •ìœ¼ë¡œ 1ì´ˆ ê°€ì…</span>
                     </button>
                     <button id="kakao-login-btn" class="w-full flex items-center justify-center space-x-2 bg-yellow-400 text-black font-bold py-3 rounded-lg transition hover:bg-yellow-500">
                         <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                             <path d="M12 3C6.48 3 2 6.48 2 12c0 5.52 4.48 10 10 10s10-4.48 10-10c0-5.52-4.48-10-10-10zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                         </svg>
                         <span>ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ 1ì´ˆ ê°€ì…</span>
                     </button>
                                         <div class="text-center mt-6">
                         <p class="text-sm text-gray-400 mb-2">âš¡ 1ì´ˆ ë§Œì— ê°€ì…í•˜ê³  ê±´ê°• ê¸°ë¡ì„ ì €ì¥í•˜ì„¸ìš”</p>
                         <p class="text-xs text-gray-500">ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ ì—†ì´ë„ ì•ˆì „í•˜ê²Œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                     </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- ëª¨ë“  UI ìš”ì†Œì™€ í™”ë©´ì„ ë³€ìˆ˜ë¡œ ì§€ì • ---
    const screens = {
        welcome: document.getElementById('welcome-screen'),
        consent: document.getElementById('consent-screen'), // ë™ì˜ í™”ë©´ ì¶”ê°€
        face: document.getElementById('face-screen'),
        transition: document.getElementById('transition-screen'),
        voice: document.getElementById('voice-screen'),
        analyzing: document.getElementById('analyzing-screen'),
        result: document.getElementById('result-screen'),
        auth: document.getElementById('auth-screen')
    };
    
    const startBtn = document.getElementById('start-btn');
    const consentCheckbox = document.getElementById('consent-checkbox');
    const agreeBtn = document.getElementById('agree-btn');
    const signupBtn = document.getElementById('signup-btn');
    const faceProgressCircle = document.getElementById('face-progress-circle');
    const faceTimerText = document.getElementById('face-timer-text');
    const voiceTimerText = document.getElementById('voice-timer-text');
    
    const FACE_DURATION = 30;
    const VOICE_DURATION = 5;
    const TRANSITION_DURATION = 2500;
    const ANALYSIS_DURATION = 3000;

    // ì¸¡ì • ê²°ê³¼ë¥¼ ì„ì‹œ ì €ì¥í•  ë³€ìˆ˜
    let currentMeasurementResult = null;
    
    // ì‚¬ìƒì²´ì§ˆ ë¶„ë¥˜ ì‹œìŠ¤í…œ
    const SASANG_TYPES = {
        SOYANG: { name: 'ì†Œì–‘ì¸ (å°‘é™½äºº)', hanja: 'å°‘é™½äºº', description: 'í™œë°œí•˜ê³  ì—´ì •ì ì¸ ì„±ê²©ìœ¼ë¡œ, ìƒìŠ¹í•˜ëŠ” ê¸°ìš´ì´ ê°•í•©ë‹ˆë‹¤.' },
        SOEUM: { name: 'ì†ŒìŒì¸ (å°‘é™°äºº)', hanja: 'å°‘é™°äºº', description: 'ì°¨ë¶„í•˜ê³  ì‹ ì¤‘í•œ ì„±ê²©ìœ¼ë¡œ, ë‚´í–¥ì ì´ì§€ë§Œ ê¹Šì€ ì‚¬ê³ ë¥¼ í•©ë‹ˆë‹¤.' },
        TAEYANG: { name: 'íƒœì–‘ì¸ (å¤ªé™½äºº)', hanja: 'å¤ªé™½äºº', description: 'ê°•ë ¬í•˜ê³  ë¦¬ë”ì‹­ì´ ê°•í•œ ì„±ê²©ìœ¼ë¡œ, í™•ì‚°í•˜ëŠ” ê¸°ìš´ì´ ê°•í•©ë‹ˆë‹¤.' },
        TAEUM: { name: 'íƒœìŒì¸ (å¤ªé™°äºº)', hanja: 'å¤ªé™°äºº', description: 'ì•ˆì •ì ì´ê³  ê· í˜•ì¡íŒ ì„±ê²©ìœ¼ë¡œ, ìˆ˜ë ´í•˜ëŠ” ê¸°ìš´ì´ ê°•í•©ë‹ˆë‹¤.' }
    };
    
    // ì‚¬ìƒì²´ì§ˆ ë¶„ë¥˜ í•¨ìˆ˜
    function classifySasangType(measurementData) {
        const { hr, hrv, stress, jitter, shimmer, hnr } = measurementData;
        
        // ê° ì²´ì§ˆë³„ ì ìˆ˜ ê³„ì‚°
        let scores = {
            [SASANG_TYPES.SOYANG.name]: 0,
            [SASANG_TYPES.SOEUM.name]: 0,
            [SASANG_TYPES.TAEYANG.name]: 0,
            [SASANG_TYPES.TAEUM.name]: 0
        };
        
        // ì‹¬ë°•ìˆ˜ ê¸°ë°˜ ë¶„ë¥˜ (ë†’ì„ìˆ˜ë¡ ì–‘ì„± ì²´ì§ˆ)
        if (hr > 75) {
            scores[SASANG_TYPES.SOYANG.name] += 3;
            scores[SASANG_TYPES.TAEYANG.name] += 2;
        } else if (hr < 65) {
            scores[SASANG_TYPES.SOEUM.name] += 3;
            scores[SASANG_TYPES.TAEUM.name] += 2;
        } else {
            scores[SASANG_TYPES.TAEUM.name] += 3;
            scores[SASANG_TYPES.SOEUM.name] += 1;
        }
        
        // HRV ê¸°ë°˜ ë¶„ë¥˜ (ë†’ì„ìˆ˜ë¡ ì•ˆì •ì )
        if (hrv > 60) {
            scores[SASANG_TYPES.TAEUM.name] += 3;
            scores[SASANG_TYPES.SOEUM.name] += 2;
        } else if (hrv < 40) {
            scores[SASANG_TYPES.SOYANG.name] += 2;
            scores[SASANG_TYPES.TAEYANG.name] += 1;
        }
        
        // ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ ê¸°ë°˜ ë¶„ë¥˜
        if (stress < 30) {
            scores[SASANG_TYPES.TAEUM.name] += 2;
            scores[SASANG_TYPES.SOEUM.name] += 1;
        } else if (stress > 70) {
            scores[SASANG_TYPES.SOYANG.name] += 2;
            scores[SASANG_TYPES.TAEYANG.name] += 1;
        }
        
        // ìŒì„± ì•ˆì •ì„± ê¸°ë°˜ ë¶„ë¥˜
        if (jitter < 1.0 && shimmer < 2.0) {
            scores[SASANG_TYPES.TAEUM.name] += 2;
            scores[SASANG_TYPES.SOEUM.name] += 1;
        } else if (jitter > 3.0 || shimmer > 4.0) {
            scores[SASANG_TYPES.SOYANG.name] += 1;
            scores[SASANG_TYPES.TAEYANG.name] += 1;
        }
        
        // HNR ê¸°ë°˜ ë¶„ë¥˜
        if (hnr > 20) {
            scores[SASANG_TYPES.TAEUM.name] += 1;
            scores[SASANG_TYPES.SOEUM.name] += 1;
        }
        
        // ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ ì²´ì§ˆ ë°˜í™˜
        let maxScore = 0;
        let classifiedType = SASANG_TYPES.TAEUM.name;
        
        for (const [type, score] of Object.entries(scores)) {
            if (score > maxScore) {
                maxScore = score;
                classifiedType = type;
            }
        }
        
        return {
            type: classifiedType,
            confidence: Math.min(95, maxScore * 15), // ì‹ ë¢°ë„ ê³„ì‚°
            scores: scores
        };
    }
    
    // ì‚¬ìƒì²´ì§ˆë³„ ê±´ê°• ì¡°ì–¸ ìƒì„±
    function generateHealthAdvice(sasangType) {
        const adviceMap = {
            [SASANG_TYPES.SOYANG.name]: {
                exercise: 'ê°€ë²¼ìš´ ìœ ì‚°ì†Œ ìš´ë™ê³¼ ëª…ìƒìœ¼ë¡œ ê³¼ì—´ëœ ê¸°ìš´ì„ ì¡°ì ˆí•˜ì„¸ìš”.',
                diet: 'ì‹œì›í•œ ì„±ì§ˆì˜ ìŒì‹ì„ ì„­ì·¨í•˜ê³ , ë§¤ìš´ ìŒì‹ì€ ì¤„ì´ì„¸ìš”.',
                lifestyle: 'ì¶©ë¶„í•œ íœ´ì‹ê³¼ ìˆ˜ë¶„ ì„­ì·¨ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.'
            },
            [SASANG_TYPES.SOEUM.name]: {
                exercise: 'ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­ê³¼ ì‚°ì±…ìœ¼ë¡œ ê¸°ìš´ì„ ìˆœí™˜ì‹œí‚¤ì„¸ìš”.',
                diet: 'ë”°ëœ»í•œ ì„±ì§ˆì˜ ìŒì‹ì„ ì„­ì·¨í•˜ê³ , ìƒëƒ‰í•œ ìŒì‹ì€ í”¼í•˜ì„¸ìš”.',
                lifestyle: 'ê·œì¹™ì ì¸ ìƒí™œê³¼ ì¶©ë¶„í•œ ìˆ˜ë©´ì´ í•„ìš”í•©ë‹ˆë‹¤.'
            },
            [SASANG_TYPES.TAEYANG.name]: {
                exercise: 'ê²©ë ¬í•œ ìš´ë™ë³´ë‹¤ëŠ” ìš”ê°€ë‚˜ íƒœê·¹ê¶Œìœ¼ë¡œ ê¸°ìš´ì„ ì¡°ì ˆí•˜ì„¸ìš”.',
                diet: 'ì‹œì›í•˜ê³  ë§‘ì€ ì„±ì§ˆì˜ ìŒì‹ì„ ì„­ì·¨í•˜ì„¸ìš”.',
                lifestyle: 'ê³¼ë¡œë¥¼ í”¼í•˜ê³  ì ì ˆí•œ íœ´ì‹ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.'
            },
            [SASANG_TYPES.TAEUM.name]: {
                exercise: 'ê· í˜•ì¡íŒ ìš´ë™ìœ¼ë¡œ ê¸°ìš´ì˜ ìˆœí™˜ì„ ë•ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.',
                diet: 'ë‹¤ì–‘í•œ ì˜ì–‘ì†Œë¥¼ ê³¨ê³ ë£¨ ì„­ì·¨í•˜ì„¸ìš”.',
                lifestyle: 'ê·œì¹™ì ì¸ ìƒí™œê³¼ ì ë‹¹í•œ ìš´ë™ì´ ê±´ê°•ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.'
            }
        };
        
        return adviceMap[sasangType] || adviceMap[SASANG_TYPES.TAEUM.name];
    }
    
    // AI ì§ˆë¬¸ ì²˜ë¦¬ ì‹œìŠ¤í…œ
    let questionCount = 0;
    const MAX_FREE_QUESTIONS = 10;
    
    // ì²´ì§ˆë³„ ë§ì¶¤ ì¶”ì²œ ë°ì´í„°
    const PERSONALIZED_RECOMMENDATIONS = {
        [SASANG_TYPES.SOYANG.name]: {
            foods: ['ì‚¼ê³„íƒ•', 'ë‹­ê³ ê¸°', 'ì°¨ê°€ìš´ ì„±ì§ˆì˜ ìŒì‹', 'ë…¹ì°¨', 'ë¯¼íŠ¸'],
            activities: ['ê°€ë²¼ìš´ ìœ ì‚°ì†Œ', 'ëª…ìƒ', 'ìš”ê°€', 'ìˆ˜ë¶„ ì„­ì·¨'],
            avoid: ['ë§¤ìš´ ìŒì‹', 'ê³¼ì‹', 'ê²©ë ¬í•œ ìš´ë™', 'ê³¼ì—´ëœ í™˜ê²½']
        },
        [SASANG_TYPES.SOEUM.name]: {
            foods: ['ì‚¼ê³„íƒ•', 'ë”°ëœ»í•œ ì„±ì§ˆì˜ ìŒì‹', 'ìƒê°•ì°¨', 'í™ì°¨', 'ê²¬ê³¼ë¥˜'],
            activities: ['ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­', 'ì‚°ì±…', 'ëª…ìƒ', 'ê·œì¹™ì ì¸ ìƒí™œ'],
            avoid: ['ìƒëƒ‰í•œ ìŒì‹', 'ê³¼ë¡œ', 'ë¶ˆê·œì¹™í•œ ìƒí™œ', 'ê³¼ë„í•œ ìš´ë™']
        },
        [SASANG_TYPES.TAEYANG.name]: {
            foods: ['ì‹œì›í•œ ì„±ì§ˆì˜ ìŒì‹', 'ë…¹ì°¨', 'ê³¼ì¼', 'ì±„ì†Œ', 'í•´ì‚°ë¬¼'],
            activities: ['ìš”ê°€', 'íƒœê·¹ê¶Œ', 'ê°€ë²¼ìš´ ìš´ë™', 'ëª…ìƒ'],
            avoid: ['ê³¼ë¡œ', 'ê²©ë ¬í•œ ìš´ë™', 'ë§¤ìš´ ìŒì‹', 'ê³¼ì‹']
        },
        [SASANG_TYPES.TAEUM.name]: {
            foods: ['ê· í˜•ì¡íŒ ì‹ë‹¨', 'ë‹¤ì–‘í•œ ì˜ì–‘ì†Œ', 'ì ë‹¹í•œ ì–‘', 'ì‹ ì„ í•œ ì¬ë£Œ'],
            activities: ['ê· í˜•ì¡íŒ ìš´ë™', 'ê·œì¹™ì ì¸ ìƒí™œ', 'ì ë‹¹í•œ íœ´ì‹', 'ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬'],
            avoid: ['ê³¼ì‹', 'ê³¼ë¡œ', 'ë¶ˆê·œì¹™í•œ ìƒí™œ', 'ê·¹ë‹¨ì ì¸ ë‹¤ì´ì–´íŠ¸']
        }
    };
    
    // Gemini API í˜¸ì¶œ í•¨ìˆ˜
    async function callGeminiAPI(question, userData) {
        try {
            // ì‚¬ìš©ì ë°ì´í„°ë¥¼ ìš”ì•½í•˜ì—¬ í† í° ì‚¬ìš©ëŸ‰ ìµœì†Œí™”
            const userContext = {
                sasangType: userData.sasangType,
                healthMetrics: {
                    heartRate: userData.hr + ' BPM',
                    hrv: userData.hrv + ' ms',
                    stress: userData.stress + '%',
                    voiceStability: `Jitter ${userData.jitter}%, Shimmer ${userData.shimmer}%`
                },
                recommendations: PERSONALIZED_RECOMMENDATIONS[userData.sasangType]
            };
            
            // í”„ë¡¬í”„íŠ¸ ìµœì í™” (í† í° ì ˆì•½)
            const prompt = `ë‹¹ì‹ ì€ í•œì˜í•™ ì‚¬ìƒì²´ì§ˆ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”:

ì‚¬ìš©ì ì •ë³´:
- ì‚¬ìƒì²´ì§ˆ: ${userContext.sasangType}
- ê±´ê°• ì§€í‘œ: ì‹¬ë°•ìˆ˜ ${userContext.healthMetrics.heartRate}, HRV ${userContext.healthMetrics.hrv}, ìŠ¤íŠ¸ë ˆìŠ¤ ${userContext.healthMetrics.stress}, ìŒì„± ì•ˆì •ì„± ${userContext.healthMetrics.voiceStability}
- ì²´ì§ˆë³„ ì¶”ì²œ: ${JSON.stringify(userContext.recommendations)}

ì‚¬ìš©ì ì§ˆë¬¸: "${question}"

ìš”êµ¬ì‚¬í•­:
1. í•œì˜í•™ ì‚¬ìƒì²´ì§ˆ ê´€ì ì—ì„œ ë‹µë³€
2. ì‚¬ìš©ìì˜ í˜„ì¬ ê±´ê°• ìƒíƒœë¥¼ ê³ ë ¤í•œ ë§ì¶¤ ì¡°ì–¸
3. êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì œì•ˆ
4. ì¹œê·¼í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ í•œêµ­ì–´
5. ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ

ë‹µë³€:`;

            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 800, // í† í° ì‚¬ìš©ëŸ‰ ì œí•œ
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
            }
            
        } catch (error) {
            console.error('Gemini API ì˜¤ë¥˜:', error);
            // API ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë¡œì§ìœ¼ë¡œ í´ë°±
            return generateLocalResponse(question, userData);
        }
    }
    
    // ë¡œì»¬ í´ë°± ì‘ë‹µ í•¨ìˆ˜ (API ì‹¤íŒ¨ ì‹œ)
    function generateLocalResponse(question, userData) {
        const sasangType = userData.sasangType;
        const recommendations = PERSONALIZED_RECOMMENDATIONS[sasangType];
        
        // ì§ˆë¬¸ í‚¤ì›Œë“œ ë¶„ì„
        const questionLower = question.toLowerCase();
        
        if (questionLower.includes('ìŠ¤íŠ¸ë ˆìŠ¤') || questionLower.includes('ìŠ¤íŠ¸ë ˆìŠ¤')) {
            if (userData.stress < 30) {
                return `í˜„ì¬ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ëŠ” ${userData.stress}%ë¡œ ë§¤ìš° ë‚®ì€ í¸ì…ë‹ˆë‹¤! ğŸ‰ ì´ëŠ” ${sasangType} ì²´ì§ˆì˜ ì•ˆì •ì ì¸ íŠ¹ì„±ì„ ì˜ ë³´ì—¬ì¤ë‹ˆë‹¤. í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ${recommendations.activities.join(', ')} ë“±ì„ ê¾¸ì¤€íˆ í•˜ì‹œë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.`;
            } else if (userData.stress > 70) {
                return `í˜„ì¬ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ëŠ” ${userData.stress}%ë¡œ ë†’ì€ í¸ì…ë‹ˆë‹¤. ğŸ˜° ${sasangType} ì²´ì§ˆì— ë§ëŠ” ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œë²•ì„ ì œì•ˆë“œë¦½ë‹ˆë‹¤: ${recommendations.activities.join(', ')}. íŠ¹íˆ ${recommendations.foods.join(', ')} ë“±ì˜ ìŒì‹ì„ ì„­ì·¨í•˜ì‹œë©´ ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤.`;
            } else {
                return `í˜„ì¬ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ëŠ” ${userData.stress}%ë¡œ ë³´í†µ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ${sasangType} ì²´ì§ˆì˜ ê· í˜•ì¡íŒ íŠ¹ì„±ì„ ì˜ ìœ ì§€í•˜ê³  ê³„ì‹œë„¤ìš”. ${recommendations.activities.join(', ')} ë“±ì„ í†µí•´ ë”ìš± ì•ˆì •ì ì¸ ìƒíƒœë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.`;
            }
        }
        
        if (questionLower.includes('ìŒì‹') || questionLower.includes('ë¨¹ì„') || questionLower.includes('ì‹ì‚¬')) {
            return `${sasangType} ì²´ì§ˆì— ì¢‹ì€ ìŒì‹ë“¤ì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤: ğŸ½ï¸\n\nâœ… ì¶”ì²œ ìŒì‹: ${recommendations.foods.join(', ')}\nâŒ í”¼í•´ì•¼ í•  ìŒì‹: ${recommendations.avoid.filter(f => f.includes('ìŒì‹')).join(', ')}\n\níŠ¹íˆ í˜„ì¬ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ ${userData.stress}%ë¥¼ ê³ ë ¤í•  ë•Œ, ${recommendations.foods[0]} ê°™ì€ ìŒì‹ì´ ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤.`;
        }
        
        if (questionLower.includes('ìš´ë™') || questionLower.includes('í™œë™')) {
            return `${sasangType} ì²´ì§ˆì— ë§ëŠ” ìš´ë™ì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤: ğŸƒâ€â™‚ï¸\n\nâœ… ì¶”ì²œ í™œë™: ${recommendations.activities.join(', ')}\nâŒ í”¼í•´ì•¼ í•  í™œë™: ${recommendations.avoid.filter(f => f.includes('ìš´ë™') || f.includes('ê³¼ë¡œ')).join(', ')}\n\ní˜„ì¬ ì‹¬ë°•ìˆ˜ ${userData.hr} BPM, HRV ${userData.hrv} msë¥¼ ê³ ë ¤í•  ë•Œ, ${recommendations.activities[0]} ê°™ì€ í™œë™ì´ ê°€ì¥ ì í•©í•©ë‹ˆë‹¤.`;
        }
        
        if (questionLower.includes('ì²´ì§ˆ') || questionLower.includes('ì‚¬ìƒ')) {
            return `${sasangType} ì²´ì§ˆì˜ íŠ¹ì§•ì„ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤: ğŸ§˜â€â™€ï¸\n\n${sasangType}ì€ ${SASANG_TYPES[sasangType]?.description || 'ì•ˆì •ì ì´ê³  ê· í˜•ì¡íŒ íŠ¹ì„±ì„ ê°€ì§„ ì²´ì§ˆì…ë‹ˆë‹¤.'}\n\ní˜„ì¬ ì¸¡ì • ê²°ê³¼ì™€ ë¹„êµí•´ë³´ë©´:\nâ€¢ ì‹¬ë°•ìˆ˜: ${userData.hr} BPM (${userData.hr > 75 ? 'ë†’ìŒ' : userData.hr < 65 ? 'ë‚®ìŒ' : 'ì •ìƒ'})\nâ€¢ HRV: ${userData.hrv} ms (${userData.hrv > 60 ? 'ë§¤ìš° ì¢‹ìŒ' : userData.hrv < 40 ? 'ë‚®ìŒ' : 'ì¢‹ìŒ'})\nâ€¢ ìŠ¤íŠ¸ë ˆìŠ¤: ${userData.stress}% (${userData.stress > 70 ? 'ë†’ìŒ' : userData.stress < 30 ? 'ë‚®ìŒ' : 'ë³´í†µ'})\n\nì´ ëª¨ë“  ì§€í‘œê°€ ${sasangType} ì²´ì§ˆì˜ íŠ¹ì„±ê³¼ ì¼ì¹˜í•©ë‹ˆë‹¤!`;
        }
        
        // ê¸°ë³¸ ì‘ë‹µ
        return `ì•ˆë…•í•˜ì„¸ìš”! ${sasangType} ì²´ì§ˆì´ì‹  ë‹¹ì‹ ì˜ ê±´ê°• ë°ì´í„°ë¥¼ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤:\n\nğŸ“Š í˜„ì¬ ìƒíƒœ:\nâ€¢ ì‹¬ë°•ìˆ˜: ${userData.hr} BPM\nâ€¢ HRV: ${userData.hrv} ms\nâ€¢ ìŠ¤íŠ¸ë ˆìŠ¤: ${userData.stress}%\nâ€¢ ìŒì„± ì•ˆì •ì„±: Jitter ${userData.jitter}%, Shimmer ${userData.shimmer}%\n\nğŸ’¡ ë§ì¶¤ ì¡°ì–¸:\n${recommendations.activities.join(', ')} ë“±ì˜ í™œë™ê³¼ ${recommendations.foods.join(', ')} ë“±ì˜ ìŒì‹ì´ ë„ì›€ì´ ë  ê²ƒì…ë‹ˆë‹¤.\n\në” êµ¬ì²´ì ì¸ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!`;
    }

    const radius = faceProgressCircle.r.baseVal.value;
    const circumference = radius * 2 * Math.PI;
    faceProgressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
    faceProgressCircle.style.strokeDashoffset = circumference;

    function setProgress(percent) {
        const offset = circumference - percent / 100 * circumference;
        faceProgressCircle.style.strokeDashoffset = offset;
    }

    // --- í™”ë©´ ì „í™˜ í•¨ìˆ˜ ---
    function showScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.remove('active'));
        screens[screenName].classList.add('active');
    }

    // --- ğŸ–ï¸ í•µì‹¬ ìˆ˜ì • ì‚¬í•­: ë™ì˜ ì ˆì°¨ ì¶”ê°€ ---
    startBtn.addEventListener('click', () => {
        // ì¸¡ì • ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ë°”ë¡œ ì¸¡ì •í•˜ëŠ” ëŒ€ì‹  ë™ì˜ í™”ë©´ì„ ë¨¼ì € ë³´ì—¬ì¤ë‹ˆë‹¤.
        showScreen('consent');
    });

    consentCheckbox.addEventListener('change', () => {
        // ë™ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ 'ê³„ì†í•˜ê¸°' ë²„íŠ¼ì„ í™œì„±í™”/ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
        agreeBtn.disabled = !consentCheckbox.checked;
    });

    agreeBtn.addEventListener('click', () => {
        // ë™ì˜ í›„ 'ê³„ì†í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ì‹¤ì œ ì¸¡ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.
        if (!consentCheckbox.checked) return;
        startFaceMeasurement();
    });
    // --- ìˆ˜ì • ë ---

    // --- ì¸¡ì • í”„ë¡œì„¸ìŠ¤ í•¨ìˆ˜ë“¤ ---
    function startFaceMeasurement() {
        showScreen('face');
        
        // ì‹¤ì œ ì¹´ë©”ë¼ ì´ˆê¸°í™” ë° ì¸¡ì • ì‹œì‘
        startMeasurementWithCamera();
        
        let timeLeft = FACE_DURATION;
        faceTimerText.textContent = timeLeft;
        setProgress(0);

        const timer = setInterval(() => {
            timeLeft--;
            faceTimerText.textContent = timeLeft;
            setProgress(((FACE_DURATION - timeLeft) / FACE_DURATION) * 100);
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                showScreen('transition');
                setTimeout(startVoiceMeasurement, TRANSITION_DURATION);
            }
        }, 1000);
    }

    function startVoiceMeasurement() {
        showScreen('voice');
        let timeLeft = VOICE_DURATION;
        voiceTimerText.textContent = timeLeft;
        
        const canvas = document.getElementById('voice-canvas');
        const ctx = canvas.getContext('2d');
        let animationFrameId;
        
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        let time = 0;
        function drawWave() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            gradient.addColorStop(0, '#67e8f9');
            gradient.addColorStop(0.5, '#0ea5e9');
            gradient.addColorStop(1, '#67e8f9');
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 3;

            for (let x = 0; x < canvas.width; x++) {
                const y = canvas.height / 2 + Math.sin(x * 0.05 + time) * 30 * (Math.sin(time * 0.5) + 1.5);
                ctx.lineTo(x, y);
            }
            ctx.stroke();
            time += 0.1;
            animationFrameId = requestAnimationFrame(drawWave);
        }
        drawWave();

        const timer = setInterval(() => {
            timeLeft--;
            voiceTimerText.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timer);
                cancelAnimationFrame(animationFrameId);
                window.removeEventListener('resize', resizeCanvas);
                startAnalysis();
            }
        }, 1000);
    }
    
    function startAnalysis() {
        showScreen('analyzing');
        // ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œ APIë¥¼ í˜¸ì¶œí•˜ê³  ê²°ê³¼ë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” ë”ë¯¸ ê²°ê³¼ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        currentMeasurementResult = {
            score: 82,
            hr: 68,
            hrv: 55,
            stress: 25,
            pitch: 130,
            jitter: 0.8,
            shimmer: 2.5,
            hnr: 22
        };

        setTimeout(() => {
            // ê²°ê³¼ í™”ë©´ì— ë°ì´í„° í‘œì‹œ
            // (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” currentMeasurementResultë¥¼ ì‚¬ìš©í•´ UIë¥¼ ì—…ë°ì´íŠ¸)
            showScreen('result');
        }, ANALYSIS_DURATION);
    }

    signupBtn.addEventListener('click', () => {
        // íšŒì›ê°€ì…/ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
        showScreen('auth');
        // ì—¬ê¸°ì„œ ë¡œê·¸ì¸/íšŒì›ê°€ì… ì„±ê³µ í›„,
        // currentMeasurementResultë¥¼ Firestoreì— ì €ì¥í•˜ëŠ” ë¡œì§ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
        // ì˜ˆ: saveResultToFirestore(auth.currentUser.uid, currentMeasurementResult);
    });
    
                                     // AI ì§ˆë¬¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          document.addEventListener('DOMContentLoaded', () => {
              // ì¸ì¦ ìƒíƒœ í™•ì¸
              checkAuthState();
              
              // í—¤ë” ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
              const headerLoginBtn = document.getElementById('header-login-btn');
              if (headerLoginBtn) {
                  headerLoginBtn.addEventListener('click', () => {
                      showScreen('auth');
                  });
              }
              
              // ì†Œì…œ ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
              const googleLoginBtn = document.getElementById('google-login-btn');
              const kakaoLoginBtn = document.getElementById('kakao-login-btn');
              
              if (googleLoginBtn) {
                  googleLoginBtn.addEventListener('click', () => {
                      handleGoogleLogin();
                  });
              }
              
              if (kakaoLoginBtn) {
                  kakaoLoginBtn.addEventListener('click', () => {
                      handleKakaoLogin();
                  });
              }
              
              const sendQuestionBtn = document.getElementById('send-question-btn');
              const userQuestion = document.getElementById('user-question');
              const aiAnswer = document.getElementById('ai-answer');
         
         if (sendQuestionBtn && userQuestion && aiAnswer) {
             sendQuestionBtn.addEventListener('click', () => {
                 handleAIQuestion();
             });
             
             // Enter í‚¤ë¡œë„ ì „ì†¡ ê°€ëŠ¥
             userQuestion.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter' && !e.shiftKey) {
                     e.preventDefault();
                     handleAIQuestion();
                 }
             });
         }
     });
    
    // AI ì§ˆë¬¸ ì²˜ë¦¬ í•¨ìˆ˜
    async function handleAIQuestion() {
        const userQuestion = document.getElementById('user-question');
        const aiAnswer = document.getElementById('ai-answer');
        const sendQuestionBtn = document.getElementById('send-question-btn');
        
        if (!userQuestion || !aiAnswer || !sendQuestionBtn) return;
        
        const question = userQuestion.value.trim();
        if (!question) {
            aiAnswer.innerHTML = '<p class="text-red-400">ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>';
            return;
        }
        
        // ë¬´ë£Œ ì§ˆë¬¸ íšŸìˆ˜ ì²´í¬
        if (questionCount >= MAX_FREE_QUESTIONS) {
            aiAnswer.innerHTML = `
                <div class="text-center">
                    <p class="text-yellow-400 font-semibold mb-2">ë¬´ë£Œ ì§ˆë¬¸ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
                    <p class="text-gray-300 mb-4">ë” ë§ì€ ë§ì¶¤ ê±´ê°• ìƒë‹´ì„ ì›í•˜ì‹œë©´ í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ë¥¼ êµ¬ë§¤í•´ì£¼ì„¸ìš”.</p>
                    <button class="bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:from-yellow-600 hover:to-orange-700 transition-all duration-300">
                        í”„ë¦¬ë¯¸ì—„ ë¦¬í¬íŠ¸ êµ¬ë§¤í•˜ê¸°
                    </button>
                </div>
            `;
            return;
        }
        
        // ì§ˆë¬¸ ì²˜ë¦¬ ì¤‘ í‘œì‹œ
        sendQuestionBtn.disabled = true;
        sendQuestionBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
        aiAnswer.innerHTML = '<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-sky-400"></div><span class="ml-2">AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span></div>';
        
        // Gemini API í˜¸ì¶œí•˜ì—¬ ì‹¤ì œ AI ì‘ë‹µ ìƒì„±
        try {
            const userData = {
                sasangType: currentMeasurementResult?.sasangType || 'íƒœìŒì¸ (å¤ªé™°äºº)',
                hr: currentMeasurementResult?.hr || 68,
                hrv: currentMeasurementResult?.hrv || 55,
                stress: currentMeasurementResult?.stress || 25,
                jitter: currentMeasurementResult?.jitter || 0.8,
                shimmer: currentMeasurementResult?.shimmer || 2.5
            };
            
            const response = await callGeminiAPI(question, userData);
            
            // ì‘ë‹µ í‘œì‹œ
            aiAnswer.innerHTML = `<p class="whitespace-pre-line">${response}</p>`;
            
            // ì§ˆë¬¸ íšŸìˆ˜ ì¦ê°€
            questionCount++;
            
            // ë‚¨ì€ ë¬´ë£Œ ì§ˆë¬¸ íšŸìˆ˜ í‘œì‹œ
            const remainingQuestions = MAX_FREE_QUESTIONS - questionCount;
            const questionCounter = document.querySelector('.bg-yellow-500\\/20');
            if (questionCounter) {
                questionCounter.textContent = `${remainingQuestions}íšŒ ë‚¨ìŒ`;
            }
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° ë²„íŠ¼ ë³µì›
            userQuestion.value = '';
            sendQuestionBtn.disabled = false;
            sendQuestionBtn.textContent = 'ì „ì†¡';
            
        } catch (error) {
            console.error('AI ì‘ë‹µ ìƒì„± ì˜¤ë¥˜:', error);
            aiAnswer.innerHTML = '<p class="text-red-400">AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
            sendQuestionBtn.disabled = false;
            sendQuestionBtn.textContent = 'ì „ì†¡';
        }
    }

    // ë ˆì´ë” ì°¨íŠ¸ ì´ˆê¸°í™”
    function initRadarChart() {
        const canvas = document.getElementById('coreMetricsChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ì‹ ì²´ í™œë ¥', 'ë§ˆìŒ ì•ˆì •', 'ìŒì„± ê±´ê°•', 'ê¸°ì§ˆ ê· í˜•'],
                    datasets: [{
                        label: 'ë‚˜ì˜ ê±´ê°• ìƒíƒœ',
                        data: [85, 90, 75, 78],
                        fill: true,
                        backgroundColor: 'rgba(14, 165, 233, 0.2)',
                        borderColor: 'rgb(14, 165, 233)',
                        pointBackgroundColor: 'rgb(14, 165, 233)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(14, 165, 233)'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' },
                            pointLabels: { color: '#fff', font: { size: 14 } },
                            ticks: {
                                color: '#0a0a0a',
                                backdropColor: 'rgba(255, 255, 255, 0.8)',
                                stepSize: 25
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    }

    // ê²°ê³¼ í™”ë©´ì´ í‘œì‹œë  ë•Œ ì°¨íŠ¸ ì´ˆê¸°í™”
    function showScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.remove('active'));
        screens[screenName].classList.add('active');
        
        // ê²°ê³¼ í™”ë©´ì¼ ë•Œ ì°¨íŠ¸ ì´ˆê¸°í™” ë° ì‚¬ìƒì²´ì§ˆ ë¶„ì„
        if (screenName === 'result') {
            setTimeout(() => {
                initRadarChart();
                updateSasangAnalysis();
            }, 100);
        }
    }
    
                   // ì†Œì…œ ë¡œê·¸ì¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë“¤
      async function handleGoogleLogin() {
          try {
              console.log('Google ë¡œê·¸ì¸ ì‹œë„...');
              
              // Google ë¡œê·¸ì¸ ì œê³µì ìƒì„±
              const provider = new firebase.auth.GoogleAuthProvider();
              provider.addScope('email');
              provider.addScope('profile');
              
              // Firebase Authë¡œ Google ë¡œê·¸ì¸
              const result = await firebase.auth().signInWithPopup(provider);
              
              if (result.user) {
                  console.log('Google ë¡œê·¸ì¸ ì„±ê³µ:', result.user.displayName);
                  
                  // ì‚¬ìš©ì ì •ë³´ ì €ì¥
                  const userData = {
                      uid: result.user.uid,
                      email: result.user.email,
                      displayName: result.user.displayName,
                      photoURL: result.user.photoURL,
                      provider: 'google'
                  };
                  
                  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                  localStorage.setItem('enoUser', JSON.stringify(userData));
                  
                  // í—¤ë” ì—…ë°ì´íŠ¸
                  updateHeaderForUser(userData);
                  
                  // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™
                  showScreen('result');
                  
                  // ì„±ê³µ ë©”ì‹œì§€
                  showNotification('Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
              }
          } catch (error) {
              console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
              
              if (error.code === 'auth/popup-closed-by-user') {
                  showNotification('ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
              } else if (error.code === 'auth/popup-blocked') {
                  showNotification('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
              } else {
                  showNotification('Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
              }
          }
      }
      
      async function handleKakaoLogin() {
          try {
              console.log('ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ ì‹œë„...');
              
              // Kakao ë¡œê·¸ì¸ ì‹¤í–‰
              const response = await new Promise((resolve, reject) => {
                  Kakao.Auth.login({
                      success: resolve,
                      fail: reject
                  });
              });
              
              if (response) {
                  // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                  const userInfo = await new Promise((resolve, reject) => {
                      Kakao.API.request({
                          url: '/v2/user/me',
                          success: resolve,
                          fail: reject
                      });
                  });
                  
                  console.log('ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ ì„±ê³µ:', userInfo);
                  
                  // Firebase Custom Token ìƒì„± (ë°±ì—”ë“œ ì—°ë™ í•„ìš”)
                  // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë°±ì—”ë“œì—ì„œ Kakao í† í°ì„ ê²€ì¦í•˜ê³  Firebase Custom Tokenì„ ìƒì„±í•´ì•¼ í•¨
                  
                  // ì„ì‹œë¡œ ë¡œì»¬ ì‚¬ìš©ì ì •ë³´ ìƒì„±
                  const userData = {
                      uid: 'kakao_' + userInfo.id,
                      email: userInfo.kakao_account?.email || null,
                      displayName: userInfo.properties?.nickname || 'ì¹´ì¹´ì˜¤ ì‚¬ìš©ì',
                      photoURL: userInfo.properties?.profile_image || null,
                      provider: 'kakao'
                  };
                  
                  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                  localStorage.setItem('enoUser', JSON.stringify(userData));
                  
                  // í—¤ë” ì—…ë°ì´íŠ¸
                  updateHeaderForUser(userData);
                  
                  // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™
                  showScreen('result');
                  
                  // ì„±ê³µ ë©”ì‹œì§€
                  showNotification('ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
              }
          } catch (error) {
              console.error('ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
              
              if (error.error === 'access_denied') {
                  showNotification('ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
              } else {
                  showNotification('ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
              }
          }
      }
      
      // ì‚¬ìš©ì ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      function checkAuthState() {
          const userData = localStorage.getItem('enoUser');
          if (userData) {
              const user = JSON.parse(userData);
              updateHeaderForUser(user);
          }
      }
      
      // í—¤ë” ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
      function updateHeaderForUser(userData) {
          const headerText = document.querySelector('.text-sm.text-gray-300');
          const loginBtn = document.getElementById('header-login-btn');
          
          if (headerText && loginBtn) {
              headerText.textContent = `ì•ˆë…•í•˜ì„¸ìš”, ${userData.displayName}ë‹˜`;
              loginBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
              loginBtn.onclick = handleLogout;
          }
      }
      
      // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
      function handleLogout() {
          // Firebase ë¡œê·¸ì•„ì›ƒ
          firebase.auth().signOut();
          
          // Kakao ë¡œê·¸ì•„ì›ƒ
          if (Kakao.Auth.getAccessToken()) {
              Kakao.Auth.logout();
          }
          
          // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë¦¬ì–´
          localStorage.removeItem('enoUser');
          
          // í—¤ë” ì´ˆê¸°í™”
          const headerText = document.querySelector('.text-sm.text-gray-300');
          const loginBtn = document.getElementById('header-login-btn');
          
          if (headerText && loginBtn) {
              headerText.textContent = 'ì•ˆë…•í•˜ì„¸ìš”, ê²ŒìŠ¤íŠ¸ë‹˜';
              loginBtn.textContent = 'ë¡œê·¸ì¸';
              loginBtn.onclick = () => showScreen('auth');
          }
          
          // ì‹œì‘ í™”ë©´ìœ¼ë¡œ ì´ë™
          showScreen('welcome');
          
          showNotification('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
      }
      
      // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
      function showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg text-white font-semibold transition-all duration-300 transform translate-x-full`;
          
          switch (type) {
              case 'success':
                  notification.className += ' bg-green-500';
                  break;
              case 'error':
                  notification.className += ' bg-red-500';
                  break;
              case 'info':
                  notification.className += ' bg-blue-500';
                  break;
              default:
                  notification.className += ' bg-gray-500';
          }
          
          notification.textContent = message;
          document.body.appendChild(notification);
          
          // ì• ë‹ˆë©”ì´ì…˜
          setTimeout(() => {
              notification.classList.remove('translate-x-full');
          }, 100);
          
          // ìë™ ì œê±°
          setTimeout(() => {
              notification.classList.add('translate-x-full');
              setTimeout(() => {
                  document.body.removeChild(notification);
              }, 300);
          }, 3000);
      }
     
     // ì‚¬ìƒì²´ì§ˆ ë¶„ì„ ê²°ê³¼ë¥¼ UIì— í‘œì‹œ
     function updateSasangAnalysis() {
         if (!currentMeasurementResult) return;
         
         // ì‚¬ìƒì²´ì§ˆ ë¶„ë¥˜
         const sasangResult = classifySasangType(currentMeasurementResult);
         
         // ì¸¡ì • ê²°ê³¼ì— ì²´ì§ˆ ì •ë³´ ì¶”ê°€
         if (currentMeasurementResult) {
             currentMeasurementResult.sasangType = sasangResult.type;
         }
         
         // UI ì—…ë°ì´íŠ¸
         const typeDisplay = document.getElementById('sasang-type-display');
         const description = document.getElementById('sasang-description');
         const confidence = document.getElementById('sasang-confidence');
         
         if (typeDisplay && description && confidence) {
             typeDisplay.textContent = sasangResult.type;
             description.textContent = `ë‹¹ì‹ ì˜ ìƒì²´ ì‹ í˜¸ëŠ” ${sasangResult.type}ì˜ íŠ¹ì„±ê³¼ ë†’ì€ ìœ ì‚¬ë„ë¥¼ ë³´ì…ë‹ˆë‹¤. AIê°€ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.`;
             confidence.textContent = `ì‹ ë¢°ë„: ${sasangResult.confidence}%`;
             
             // ê±´ê°• ì¡°ì–¸ í‘œì‹œ
             const healthAdvice = generateHealthAdvice(sasangResult.type);
             const exerciseAdvice = document.getElementById('exercise-advice');
             const dietAdvice = document.getElementById('diet-advice');
             const lifestyleAdvice = document.getElementById('lifestyle-advice');
             const adviceSection = document.getElementById('health-advice-section');
             
             if (exerciseAdvice && dietAdvice && lifestyleAdvice && adviceSection) {
                 exerciseAdvice.textContent = healthAdvice.exercise;
                 dietAdvice.textContent = healthAdvice.diet;
                 lifestyleAdvice.textContent = healthAdvice.lifestyle;
                 adviceSection.classList.remove('hidden');
             }
         }
     }

     // ì‹¤ì œ ì¹´ë©”ë¼ ê¸°ëŠ¥ ì¶”ê°€
     let mediaStream = null;
     let mediaRecorder = null;
     let rppgData = [];
     let voiceData = [];
     
     // ì¹´ë©”ë¼ ì´ˆê¸°í™”
     async function initializeCamera() {
         try {
             console.log('ì¹´ë©”ë¼ ì´ˆê¸°í™” ì‹œì‘...');
             
             mediaStream = await navigator.mediaDevices.getUserMedia({
                 video: {
                     width: { ideal: 640 },
                     height: { ideal: 480 },
                     facingMode: 'user'
                 },
                 audio: false
             });
             
             console.log('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ íšë“ ì„±ê³µ:', mediaStream);
             
             // ì¹´ë©”ë¼ í”¼ë“œê°€ ìˆë‹¤ë©´ ì—°ê²°
             const cameraFeed = document.getElementById('camera-feed');
             if (cameraFeed) {
                 cameraFeed.srcObject = mediaStream;
                 console.log('ì¹´ë©”ë¼ í”¼ë“œ ì—°ê²° ì™„ë£Œ');
             }
             
             return true;
         } catch (error) {
             console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);
             
             if (error.name === 'NotAllowedError') {
                 showNotification('ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'error');
             } else if (error.name === 'NotFoundError') {
                 showNotification('ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
             } else {
                 showNotification(`ì¹´ë©”ë¼ ì ‘ê·¼ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
             }
             
             return false;
         }
     }
     
     // RPPG ë°ì´í„° ìˆ˜ì§‘
     function startRPPGDataCollection() {
         rppgData = [];
         const canvas = document.createElement('canvas');
         const ctx = canvas.getContext('2d');
         canvas.width = 640;
         canvas.height = 480;
         
         const captureFrame = () => {
             if (mediaStream && mediaStream.active) {
                 try {
                     const cameraFeed = document.getElementById('camera-feed');
                     if (cameraFeed && cameraFeed.videoWidth > 0) {
                         ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
                         const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                         
                         // ë…¹ìƒ‰ ì±„ë„ ì¶”ì¶œ (RPPGì— ê°€ì¥ ë¯¼ê°)
                         const greenChannel = [];
                         for (let i = 0; i < imageData.data.length; i += 4) {
                             greenChannel.push(imageData.data[i + 1]); // G ì±„ë„
                         }
                         
                         const avgGreen = greenChannel.reduce((a, b) => a + b, 0) / greenChannel.length;
                         rppgData.push({
                             timestamp: Date.now(),
                             greenValue: avgGreen,
                             frameIndex: rppgData.length
                         });
                     }
                 } catch (error) {
                     console.error('í”„ë ˆì„ ìº¡ì²˜ ì˜¤ë¥˜:', error);
                 }
             }
         };
         
         // 30ì´ˆ ë™ì•ˆ 30fpsë¡œ í”„ë ˆì„ ìº¡ì²˜
         const interval = setInterval(captureFrame, 1000 / 30);
         
         setTimeout(() => {
             clearInterval(interval);
             console.log('RPPG ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ:', rppgData.length, 'í”„ë ˆì„');
         }, 30000); // 30ì´ˆ
     }
     
     // ìŒì„± ë°ì´í„° ìˆ˜ì§‘
     function startVoiceDataCollection() {
         voiceData = [];
         
         navigator.mediaDevices.getUserMedia({ audio: true })
             .then(stream => {
                 mediaRecorder = new MediaRecorder(stream);
                 
                 mediaRecorder.ondataavailable = (event) => {
                     if (event.data.size > 0) {
                         voiceData.push(event.data);
                     }
                 };
                 
                 mediaRecorder.start();
                 console.log('ìŒì„± ë…¹ìŒ ì‹œì‘');
                 
                 setTimeout(() => {
                     mediaRecorder.stop();
                     stream.getTracks().forEach(track => track.stop());
                     console.log('ìŒì„± ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ:', voiceData.length, 'ì²­í¬');
                 }, 5000); // 5ì´ˆ
             })
             .catch(error => {
                 console.error('ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:', error);
                 showNotification('ë§ˆì´í¬ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
             });
     }
     
     // ì¸¡ì • ì‹œì‘ ì‹œ ì¹´ë©”ë¼ ì´ˆê¸°í™”
     function startMeasurementWithCamera() {
         console.log('ì¹´ë©”ë¼ ì¸¡ì • ì‹œì‘...');
         initializeCamera().then(success => {
             if (success) {
                 showNotification('ì¹´ë©”ë¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                 startRPPGDataCollection();
                 
                 // 30ì´ˆ í›„ ìŒì„± ì¸¡ì • ì‹œì‘
                 setTimeout(() => {
                     startVoiceDataCollection();
                 }, 30000);
             }
         });
     }
     
     // ì¹´ë©”ë¼ ì •ë¦¬
     function cleanupCamera() {
         if (mediaStream) {
             mediaStream.getTracks().forEach(track => track.stop());
             mediaStream = null;
         }
     }
     
     // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
     window.addEventListener('beforeunload', cleanupCamera);

</script>
</body>
</html> 